# v1.1 任务 4.1 - 更新视频生成表单组件

## 层级
第4层 - 依赖 Layer 3

## 并行任务
- v1.1-4.2-update-workspace-store.md (可同时进行)

## 任务目标
在VideoForm组件中添加4个新的表单字段UI，包括时长选择、宽高比选择、运动强度滑块和质量预设选择。

## 前置条件
- 任务 3.1 已完成（TypeScript类型定义）
- TailwindCSS 已配置

## 执行步骤

### 1. 更新VideoForm组件结构
**文件**: `frontend/src/components/VideoForm.tsx`

在组件顶部添加新的导入：

```tsx
import {
  VideoFormData,
  DURATION_OPTIONS_META,
  ASPECT_RATIO_OPTIONS_META,
  MOTION_INTENSITY_LEVELS,
  MOTION_INTENSITY_LABELS,
  MOTION_INTENSITY_DESCRIPTIONS,
  QUALITY_PRESET_OPTIONS_META,
  Duration,
  AspectRatio,
  MotionIntensity,
  QualityPreset
} from '../types/workspace';
```

### 2. 添加新字段的状态和处理函数

在组件内部，更新表单状态管理：

```tsx
// 假设使用受控组件
const [formData, setFormData] = useState<VideoFormData>({
  // v1.0 fields
  camera_movement: '',
  shot_type: '',
  lighting: '',
  motion_prompt: '',
  checkboxes: {},
  // v1.1 new fields
  duration: 5,  // Qwen API最小值
  aspect_ratio: '16:9',
  motion_intensity: 3,
  quality_preset: 'standard'
});

// 通用change handler
const handleChange = (field: keyof VideoFormData, value: any) => {
  setFormData(prev => ({
    ...prev,
    [field]: value
  }));
};
```

### 3. 创建Duration选择器

在表单顶部添加"基础参数"区域：

```tsx
{/* ===== 基础参数区域 (v1.1新增) ===== */}
<div className="form-section bg-gray-50 p-4 rounded-lg mb-4">
  <h3 className="text-sm font-semibold text-gray-700 mb-3">基础参数</h3>

  {/* Duration 时长选择 */}
  <div className="mb-4">
    <label htmlFor="duration" className="block text-sm font-medium text-gray-700 mb-2">
      视频时长
    </label>
    <select
      id="duration"
      name="duration"
      value={formData.duration}
      onChange={(e) => handleChange('duration', Number(e.target.value) as Duration)}
      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
    >
      {DURATION_OPTIONS_META.map(option => (
        <option key={option.value} value={option.value}>
          {option.label} - {option.description}
        </option>
      ))}
    </select>
  </div>

  {/* 剩余字段... */}
</div>
```

### 4. 创建Aspect Ratio选择器（图标式单选）

```tsx
{/* Aspect Ratio 宽高比选择 */}
<div className="mb-4">
  <label className="block text-sm font-medium text-gray-700 mb-2">
    宽高比
  </label>
  <div className="grid grid-cols-4 gap-2">
    {ASPECT_RATIO_OPTIONS_META.map(option => (
      <button
        key={option.value}
        type="button"
        onClick={() => handleChange('aspect_ratio', option.value)}
        className={`
          relative p-3 border-2 rounded-lg transition-all
          ${formData.aspect_ratio === option.value
            ? 'border-blue-500 bg-blue-50'
            : 'border-gray-300 hover:border-gray-400 bg-white'
          }
        `}
      >
        <div className="text-2xl mb-1">{option.icon}</div>
        <div className="text-xs font-semibold">{option.label}</div>
        <div className="text-xs text-gray-500 mt-1">{option.description}</div>
      </button>
    ))}
  </div>
</div>
```

### 5. 创建Quality Preset选择器

```tsx
{/* Quality Preset 质量预设 */}
<div className="mb-4">
  <label htmlFor="quality_preset" className="block text-sm font-medium text-gray-700 mb-2">
    质量预设
  </label>
  <select
    id="quality_preset"
    name="quality_preset"
    value={formData.quality_preset}
    onChange={(e) => handleChange('quality_preset', e.target.value as QualityPreset)}
    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
  >
    {QUALITY_PRESET_OPTIONS_META.map(option => (
      <option key={option.value} value={option.value}>
        {option.label} ({option.resolution}, {option.estimatedTime}) {option.value === 'standard' ? '✓ 推荐' : ''}
      </option>
    ))}
  </select>
  <p className="text-xs text-gray-500 mt-1">
    预计生成时间：{
      QUALITY_PRESET_OPTIONS_META.find(o => o.value === formData.quality_preset)?.estimatedTime
    }
  </p>
</div>
```

### 6. 创建Motion Intensity滑块

在"运动控制"区域添加：

```tsx
{/* ===== 运动控制区域 (v1.0 + v1.1) ===== */}
<div className="form-section p-4 border border-gray-200 rounded-lg mb-4">
  <h3 className="text-sm font-semibold text-gray-700 mb-3">运动控制</h3>

  {/* Motion Intensity 运动强度滑块 */}
  <div className="mb-4">
    <label htmlFor="motion_intensity" className="block text-sm font-medium text-gray-700 mb-2">
      运动强度
    </label>

    {/* 滑块 */}
    <div className="relative">
      <input
        type="range"
        id="motion_intensity"
        name="motion_intensity"
        min={1}
        max={5}
        step={1}
        value={formData.motion_intensity}
        onChange={(e) => handleChange('motion_intensity', Number(e.target.value) as MotionIntensity)}
        className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
      />

      {/* 刻度标记 */}
      <div className="flex justify-between text-xs text-gray-500 mt-1">
        {MOTION_INTENSITY_LEVELS.map(level => (
          <span key={level} className={formData.motion_intensity === level ? 'font-bold text-blue-600' : ''}>
            {level}
          </span>
        ))}
      </div>
    </div>

    {/* 当前选中的强度标签和描述 */}
    <div className="mt-2 text-center">
      <span className="inline-block px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold">
        {MOTION_INTENSITY_LABELS[formData.motion_intensity as MotionIntensity]}
      </span>
      <p className="text-xs text-gray-600 mt-1">
        {MOTION_INTENSITY_DESCRIPTIONS[formData.motion_intensity as MotionIntensity]}
      </p>
    </div>
  </div>

  {/* Motion Prompt (v1.0 保留) */}
  <div className="mb-4">
    <label htmlFor="motion_prompt" className="block text-sm font-medium text-gray-700 mb-2">
      主体运动描述
    </label>
    <textarea
      id="motion_prompt"
      name="motion_prompt"
      value={formData.motion_prompt}
      onChange={(e) => handleChange('motion_prompt', e.target.value)}
      rows={3}
      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
      placeholder="描述画面中主体的动作、情绪、变化等..."
    />
  </div>
</div>
```

### 7. 添加自定义CSS（如果需要）

在 `frontend/src/App.css` 或组件样式中添加滑块样式：

```css
/* 自定义滑块样式 */
.slider::-webkit-slider-thumb {
  appearance: none;
  width: 20px;
  height: 20px;
  background: #3b82f6;
  border-radius: 50%;
  cursor: pointer;
  transition: all 0.2s;
}

.slider::-webkit-slider-thumb:hover {
  background: #2563eb;
  transform: scale(1.2);
}

.slider::-moz-range-thumb {
  width: 20px;
  height: 20px;
  background: #3b82f6;
  border-radius: 50%;
  cursor: pointer;
  border: none;
  transition: all 0.2s;
}

.slider::-moz-range-thumb:hover {
  background: #2563eb;
  transform: scale(1.2);
}
```

### 8. 更新表单提交逻辑

确保表单提交时包含所有v1.1字段：

```tsx
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault();

  // 验证v1.1字段
  const { valid, errors } = validateV1_1FormData(formData);
  if (!valid) {
    console.error('Validation errors:', errors);
    // 显示错误提示
    return;
  }

  // 提交到后端
  try {
    await apiClient.post('/api/generate/video', {
      workspace_id: currentWorkspaceId,
      form_data: formData  // 包含所有v1.1字段
    });
  } catch (error) {
    console.error('Video generation failed:', error);
  }
};
```

### 9. 测试表单交互

手动测试所有新字段：

**测试清单**：
- [ ] Duration下拉框可以选择2/4/6/8秒
- [ ] Aspect Ratio按钮可以点击切换，选中状态高亮
- [ ] Quality Preset下拉框可以选择，显示预计时间
- [ ] Motion Intensity滑块可以拖动，显示当前标签和描述
- [ ] 滑块刻度对齐
- [ ] 所有字段change时formData正确更新
- [ ] 提交表单时包含所有v1.1字段
- [ ] 表单验证生效（例如不允许无效值）

### 10. 响应式布局测试

测试移动端适配：

```bash
# 在浏览器开发者工具中测试不同屏幕尺寸
# - iPhone SE (375px)
# - iPad (768px)
# - Desktop (1920px)
```

确保：
- [ ] Aspect Ratio按钮在小屏幕上正确换行或滚动
- [ ] 滑块在移动端可点击
- [ ] 下拉框在移动端易用

## 验收标准

- [ ] VideoForm组件已更新，包含4个新字段UI
- [ ] 所有新字段使用正确的TypeScript类型
- [ ] Duration: 下拉框，4个选项
- [ ] Aspect Ratio: 图标式单选按钮，4个选项，视觉高亮
- [ ] Motion Intensity: 滑块（1-5），实时显示标签和描述
- [ ] Quality Preset: 下拉框，显示分辨率和预计时间
- [ ] 所有字段change时state正确更新
- [ ] 表单提交包含所有v1.1字段
- [ ] UI符合TailwindCSS设计规范
- [ ] 响应式布局在移动端正常工作
- [ ] 无TypeScript编译错误
- [ ] 无控制台警告或错误

## 输出物

1. 更新的VideoForm组件：`frontend/src/components/VideoForm.tsx`
2. 自定义CSS（如果需要）：在 `App.css` 中
3. 手动测试报告（截图 + 测试清单）

## UI预览示例

完成后的表单应该看起来像这样：

```
┌─────────────────────────────────────┐
│ 基础参数                            │
├─────────────────────────────────────┤
│ 视频时长                            │
│ [4秒 - 标准场景长度 ▼]              │
│                                     │
│ 宽高比                              │
│ [🖥️ 16:9] [📱 9:16] [◻️ 1:1] [📺 4:3] │
│   ^^^选中                           │
│                                     │
│ 质量预设                            │
│ [标准 (1080p, ~2分钟) ✓ ▼]          │
│ 预计生成时间：~2分钟                │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 运动控制                            │
├─────────────────────────────────────┤
│ 运动强度                            │
│ ●━━━━━━━━━●━━━━━━━━━●               │
│ 1    2    3    4    5               │
│      [ 中等 ]                       │
│ 自然节奏，适合大多数场景             │
│                                     │
│ 主体运动描述                        │
│ ┌─────────────────────────────────┐ │
│ │人物缓缓转身，眼神望向远方...     │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

## 下一步

- v1.1-4.2-update-workspace-store.md (更新Zustand store)
- v1.1-6.1-integration-testing.md (集成测试)

## 预计耗时
8 小时

## 依赖任务
- v1.1-3.1-update-type-definitions.md（TypeScript类型）
