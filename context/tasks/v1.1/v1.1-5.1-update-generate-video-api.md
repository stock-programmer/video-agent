# v1.1 任务 5.1 - 更新视频生成API

## 层级
第5层 - 依赖 Layer 2, Layer 4

## 并行任务
- v1.1-5.2-update-websocket-handlers.md (可同时进行)

## 任务目标
更新视频生成API端点，接收v1.1新参数并正确传递给Qwen API，实现参数映射和fallback逻辑。

## 前置条件
- 任务 1.1 已完成（API参数验证）
- 任务 2.1 已完成（数据库Schema更新）

## 执行步骤

### 1. 更新API端点以接收新参数
**文件**: `backend/src/api/generate-video.js`

```javascript
const express = require('express');
const { Workspace } = require('../db/mongodb');
const { generateVideo } = require('../services/video-qwen');
const logger = require('../utils/logger');

const router = express.Router();

router.post('/generate/video', async (req, res) => {
  try {
    const { workspace_id, form_data } = req.body;

    if (!workspace_id) {
      return res.status(400).json({ error: 'workspace_id is required' });
    }

    // 查找workspace
    const workspace = await Workspace.findById(workspace_id);
    if (!workspace) {
      return res.status(404).json({ error: 'Workspace not found' });
    }

    // ===== v1.1: 提取新参数（带默认值） =====
    const {
      // v1.0 parameters
      camera_movement,
      shot_type,
      lighting,
      motion_prompt,
      checkboxes,

      // v1.1 new parameters (with defaults)
      duration = 4,
      aspect_ratio = '16:9',
      motion_intensity = 3,
      quality_preset = 'standard'
    } = form_data;

    // ===== v1.1: 参数验证 =====
    if (![2, 4, 6, 8].includes(duration)) {
      return res.status(400).json({ error: `Invalid duration: ${duration}` });
    }

    if (!['16:9', '9:16', '1:1', '4:3'].includes(aspect_ratio)) {
      return res.status(400).json({ error: `Invalid aspect_ratio: ${aspect_ratio}` });
    }

    if (motion_intensity < 1 || motion_intensity > 5) {
      return res.status(400).json({ error: `Invalid motion_intensity: ${motion_intensity}` });
    }

    if (!['draft', 'standard', 'high'].includes(quality_preset)) {
      return res.status(400).json({ error: `Invalid quality_preset: ${quality_preset}` });
    }

    logger.info('Video generation request', {
      workspace_id,
      duration,
      aspect_ratio,
      motion_intensity,
      quality_preset
    });

    // ===== 调用video service =====
    const result = await generateVideo({
      workspace_id,
      image_url: workspace.image_url,
      form_data: {
        camera_movement,
        shot_type,
        lighting,
        motion_prompt,
        duration,           // v1.1
        aspect_ratio,       // v1.1
        motion_intensity,   // v1.1
        quality_preset      // v1.1
      }
    });

    res.json({
      success: true,
      task_id: result.task_id,
      message: 'Video generation started'
    });

  } catch (error) {
    logger.error('Video generation failed', { error: error.message, stack: error.stack });
    res.status(500).json({ error: 'Failed to generate video', details: error.message });
  }
});

module.exports = router;
```

### 2. 更新Qwen Video Service
**文件**: `backend/src/services/video-qwen.js`

根据任务1.1的API验证结果，实现参数映射：

```javascript
const axios = require('axios');
const config = require('../config');
const logger = require('../utils/logger');
const { Workspace } = require('../db/mongodb');

/**
 * v1.1: 将quality_preset映射到resolution
 */
function mapQualityToResolution(quality_preset) {
  const mapping = {
    'draft': '720p',
    'standard': '1080p',
    'high': '1080p'  // May need different API parameter for "high"
  };
  return mapping[quality_preset] || '1080p';
}

/**
 * v1.1: 根据motion_intensity添加关键词到prompt
 * (如果API不原生支持motion_intensity参数)
 */
function enhancePromptWithIntensity(prompt, motion_intensity) {
  const intensityKeywords = {
    1: 'very slowly, subtle movement',
    2: 'slowly, gentle',
    3: 'naturally, moderate pace',
    4: 'quickly, dynamic',
    5: 'very fast, highly dynamic, energetic'
  };

  const keyword = intensityKeywords[motion_intensity] || intensityKeywords[3];

  // Append to prompt
  return `${prompt}, ${keyword}`;
}

/**
 * v1.1: 映射aspect_ratio到API参数
 */
function mapAspectRatio(aspect_ratio) {
  // 根据API文档映射
  // 例如: '16:9' → { width: 1920, height: 1080 }
  //       '9:16' → { width: 1080, height: 1920 }

  const mapping = {
    '16:9': { width: 1920, height: 1080 },
    '9:16': { width: 1080, height: 1920 },
    '1:1': { width: 1080, height: 1080 },
    '4:3': { width: 1440, height: 1080 }
  };

  return mapping[aspect_ratio] || mapping['16:9'];
}

async function generateVideo({ workspace_id, image_url, form_data }) {
  try {
    const {
      motion_prompt,
      camera_movement,
      shot_type,
      lighting,
      duration,
      aspect_ratio,
      motion_intensity,
      quality_preset
    } = form_data;

    // ===== v1.1: 构建增强的prompt =====
    let enhancedPrompt = motion_prompt;

    // 如果API不支持motion_intensity参数，则添加到prompt
    // (根据任务1.1的测试结果决定是否需要)
    if (process.env.QWEN_SUPPORTS_MOTION_INTENSITY !== 'true') {
      enhancedPrompt = enhancePromptWithIntensity(motion_prompt, motion_intensity);
    }

    // ===== v1.1: 构建API请求参数 =====
    const resolution = mapAspectRatio(aspect_ratio);
    const apiParams = {
      model: 'wan2.6-i2v',
      input: {
        image_url: image_url,
        prompt: enhancedPrompt
      },
      parameters: {
        // v1.1 parameters (adjust based on actual API support)
        duration: duration,  // If supported
        width: resolution.width,
        height: resolution.height,
        // quality/resolution mapping
        // ... add other parameters as needed
      }
    };

    // 如果API支持motion_intensity参数
    if (process.env.QWEN_SUPPORTS_MOTION_INTENSITY === 'true') {
      apiParams.parameters.motion_intensity = motion_intensity;
    }

    logger.info('Calling Qwen API with v1.1 parameters', {
      workspace_id,
      duration,
      aspect_ratio,
      resolution,
      motion_intensity,
      quality_preset
    });

    // ===== 调用Qwen API =====
    const response = await axios.post(
      `${config.DASHSCOPE_API_BASE}/services/aigc/video-generation/generation`,
      apiParams,
      {
        headers: {
          'Authorization': `Bearer ${config.DASHSCOPE_API_KEY}`,
          'Content-Type': 'application/json'
        }
      }
    );

    const { task_id, status } = response.data.output;

    // 更新workspace
    await Workspace.findByIdAndUpdate(workspace_id, {
      'video.task_id': task_id,
      'video.status': 'generating'
    });

    // 开始轮询
    startPolling(workspace_id, task_id);

    return { task_id, status };

  } catch (error) {
    logger.error('Qwen API call failed', {
      error: error.message,
      response: error.response?.data
    });

    // 更新workspace为失败状态
    await Workspace.findByIdAndUpdate(workspace_id, {
      'video.status': 'failed',
      'video.error': error.response?.data?.message || error.message
    });

    throw error;
  }
}

// ... 保留原有的polling逻辑 ...

module.exports = { generateVideo };
```

### 3. 添加环境变量配置
**文件**: `backend/.env`

根据任务1.1的测试结果添加：

```env
# v1.1: Qwen API capabilities (set based on verification results)
QWEN_SUPPORTS_DURATION=true
QWEN_SUPPORTS_ASPECT_RATIO=true
QWEN_SUPPORTS_MOTION_INTENSITY=false
QWEN_SUPPORTS_QUALITY_TIERS=true
```

**文件**: `backend/src/config.js`

```javascript
module.exports = {
  // ... existing config ...

  // v1.1: API capabilities
  QWEN_SUPPORTS_DURATION: process.env.QWEN_SUPPORTS_DURATION === 'true',
  QWEN_SUPPORTS_ASPECT_RATIO: process.env.QWEN_SUPPORTS_ASPECT_RATIO === 'true',
  QWEN_SUPPORTS_MOTION_INTENSITY: process.env.QWEN_SUPPORTS_MOTION_INTENSITY === 'true',
  QWEN_SUPPORTS_QUALITY_TIERS: process.env.QWEN_SUPPORTS_QUALITY_TIERS === 'true'
};
```

### 4. 创建API测试脚本
**文件**: `backend/test-generate-video-v1.1.js`

```javascript
const axios = require('axios');
require('dotenv').config();

const API_BASE = process.env.SERVER_URL || 'http://localhost:3000';

async function testVideoGeneration() {
  console.log('=== Testing v1.1 Video Generation API ===\n');

  // Test cases
  const testCases = [
    {
      name: 'Default values',
      payload: {
        workspace_id: 'test_workspace_id',
        form_data: {
          motion_prompt: 'Person walking'
          // No v1.1 fields - should use defaults
        }
      }
    },
    {
      name: 'Custom duration',
      payload: {
        workspace_id: 'test_workspace_id',
        form_data: {
          motion_prompt: 'Person running',
          duration: 8
        }
      }
    },
    {
      name: 'Vertical video (9:16)',
      payload: {
        workspace_id: 'test_workspace_id',
        form_data: {
          motion_prompt: 'Portrait shot',
          aspect_ratio: '9:16'
        }
      }
    },
    {
      name: 'High intensity + High quality',
      payload: {
        workspace_id: 'test_workspace_id',
        form_data: {
          motion_prompt: 'Fast action scene',
          motion_intensity: 5,
          quality_preset: 'high'
        }
      }
    },
    {
      name: 'All v1.1 parameters',
      payload: {
        workspace_id: 'test_workspace_id',
        form_data: {
          motion_prompt: 'Cinematic scene',
          duration: 6,
          aspect_ratio: '1:1',
          motion_intensity: 4,
          quality_preset: 'standard'
        }
      }
    }
  ];

  for (const testCase of testCases) {
    console.log(`\n[Test] ${testCase.name}`);
    console.log('Payload:', JSON.stringify(testCase.payload, null, 2));

    try {
      const response = await axios.post(
        `${API_BASE}/api/generate/video`,
        testCase.payload
      );

      console.log('✅ Success:', response.data);
    } catch (error) {
      console.log('❌ Failed:', error.response?.data || error.message);
    }
  }

  console.log('\n=== Tests Complete ===');
}

testVideoGeneration().catch(console.error);
```

### 5. 运行测试
```bash
cd backend
node test-generate-video-v1.1.js
```

### 6. 验证日志
检查Winston日志，确认参数正确传递：

```bash
tail -f backend/logs/combined.log | grep "v1.1"
```

应该看到：
```
info: Video generation request { workspace_id: '...', duration: 8, aspect_ratio: '16:9', ... }
info: Calling Qwen API with v1.1 parameters { ... }
```

## 验收标准

- [ ] API端点接收v1.1的4个新参数
- [ ] 参数验证逻辑正确（拒绝无效值）
- [ ] 参数映射函数实现（quality→resolution, aspect_ratio→width/height）
- [ ] 如果API不支持，实现了workaround（如motion_intensity→prompt）
- [ ] 环境变量配置API能力标志
- [ ] 日志记录v1.1参数
- [ ] 测试脚本运行成功
- [ ] 所有5个测试用例通过
- [ ] 向后兼容（没有v1.1字段时使用默认值）
- [ ] 数据库正确保存v1.1字段
- [ ] 视频生成成功（轮询完成）

## 输出物

1. 更新的API端点：`backend/src/api/generate-video.js`
2. 更新的Video Service：`backend/src/services/video-qwen.js`
3. 更新的配置：`backend/src/config.js`, `backend/.env`
4. 测试脚本：`backend/test-generate-video-v1.1.js`
5. 测试报告（日志截图）

## 参数映射参考

根据任务1.1的验证结果，填写实际的参数映射：

| v1.1 参数 | Qwen API参数 | 映射逻辑 | Workaround（如不支持） |
|-----------|--------------|----------|------------------------|
| duration: 4 | duration: 4 | 直接传递 | 使用API默认 |
| aspect_ratio: '9:16' | width: 1080, height: 1920 | 映射到分辨率 | 前端裁剪图片 |
| motion_intensity: 5 | ? | ? | 添加关键词到prompt |
| quality_preset: 'high' | resolution: '1080p' | 映射表 | - |

## 下一步

- v1.1-5.2-update-websocket-handlers.md (WebSocket处理器)
- v1.1-6.1-integration-testing.md (集成测试)

## 预计耗时
6 小时

## 依赖任务
- v1.1-1.1-verify-qwen-api.md（API能力验证）
- v1.1-2.1-update-database-schema.md（数据库Schema）
