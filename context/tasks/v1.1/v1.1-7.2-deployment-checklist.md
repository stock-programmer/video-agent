# v1.1 任务 7.2 - 部署检查清单和准备

## 层级
第7层 - 依赖 7.1

## 并行任务
无（最后一个任务）

## 任务目标
准备v1.1的生产部署，包括部署脚本、检查清单、回滚方案和监控配置。

## 前置条件
- 所有测试通过
- 文档已更新
- 代码已提交到版本控制

## 执行步骤

### 1. 创建部署前检查清单

**文件**: `deployment/v1.1-pre-deployment-checklist.md`

```markdown
# v1.1 Pre-Deployment Checklist

## Code Quality
- [ ] 所有代码已提交到Git
- [ ] 无未提交的更改 (`git status` clean)
- [ ] 所有TODO注释已解决或标注为future
- [ ] 无console.log或调试代码
- [ ] ESLint无错误
- [ ] TypeScript编译无错误

## Testing
- [ ] 集成测试全部通过 (v1.1-6.1)
- [ ] 向后兼容性测试通过 (v1.1-6.2)
- [ ] 单元测试覆盖率 >70%
- [ ] 手动测试所有核心流程
- [ ] 跨浏览器测试完成
- [ ] 移动端响应式测试完成

## Documentation
- [ ] CLAUDE.md已更新
- [ ] Release Notes已创建
- [ ] API文档已更新
- [ ] 用户指南已创建
- [ ] 部署文档已准备

## Database
- [ ] MongoDB schema更新已验证
- [ ] 数据库迁移脚本已测试
- [ ] 生产数据库已备份
- [ ] 索引已优化

## Configuration
- [ ] 生产环境.env文件已准备
- [ ] API密钥已更新和验证
- [ ] 所有敏感信息不在代码中
- [ ] CORS配置正确
- [ ] WebSocket端口配置正确

## Dependencies
- [ ] 所有npm依赖已安装
- [ ] 依赖版本已锁定 (package-lock.json)
- [ ] 无已知安全漏洞 (npm audit)
- [ ] 无过时依赖

## Performance
- [ ] 前端build优化 (minify, tree-shaking)
- [ ] 后端无性能瓶颈
- [ ] 数据库查询已优化
- [ ] WebSocket连接稳定

## Security
- [ ] 无SQL注入风险
- [ ] 无XSS风险
- [ ] 文件上传有大小限制
- [ ] API有rate limiting (optional)
- [ ] HTTPS已启用 (生产环境)

## Monitoring
- [ ] 日志系统正常工作
- [ ] 错误追踪已配置 (optional)
- [ ] 性能监控已配置 (optional)
- [ ] 警报规则已设置 (optional)

## Rollback Plan
- [ ] 回滚脚本已准备
- [ ] 数据库回滚方案已测试
- [ ] 回滚触发条件已定义
- [ ] 团队知晓回滚流程
```

### 2. 创建部署脚本

**文件**: `deployment/deploy-v1.1.sh`

```bash
#!/bin/bash

echo "======================================="
echo "  v1.1 Deployment Script"
echo "======================================="

set -e  # Exit on error

# Configuration
BACKUP_DIR="./backups/v1.1-$(date +%Y%m%d-%H%M%S)"
FRONTEND_DIR="./frontend"
BACKEND_DIR="./backend"
DB_NAME="video-maker"

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Step 1: Pre-deployment checks${NC}"
echo "Checking git status..."
if [ -n "$(git status --porcelain)" ]; then
  echo -e "${RED}Error: You have uncommitted changes!${NC}"
  exit 1
fi
echo -e "${GREEN}✓ Git status clean${NC}"

echo -e "\n${YELLOW}Step 2: Backup production database${NC}"
mkdir -p "$BACKUP_DIR"
echo "Backing up MongoDB to $BACKUP_DIR..."
mongodump --db=$DB_NAME --out="$BACKUP_DIR"
echo -e "${GREEN}✓ Database backup complete${NC}"

echo -e "\n${YELLOW}Step 3: Run database migration (optional)${NC}"
read -p "Run database migration? (y/n): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
  cd "$BACKEND_DIR"
  node migrate-v1-1.js
  cd ..
  echo -e "${GREEN}✓ Migration complete${NC}"
else
  echo "Skipping migration..."
fi

echo -e "\n${YELLOW}Step 4: Install dependencies${NC}"
echo "Installing backend dependencies..."
cd "$BACKEND_DIR"
npm ci  # Use ci for clean install
echo -e "${GREEN}✓ Backend dependencies installed${NC}"

cd ..
echo "Installing frontend dependencies..."
cd "$FRONTEND_DIR"
npm ci
echo -e "${GREEN}✓ Frontend dependencies installed${NC}"
cd ..

echo -e "\n${YELLOW}Step 5: Build frontend${NC}"
cd "$FRONTEND_DIR"
npm run build
echo -e "${GREEN}✓ Frontend build complete${NC}"
cd ..

echo -e "\n${YELLOW}Step 6: Restart backend service${NC}"
cd "$BACKEND_DIR"
# Assuming using PM2 or similar process manager
# pm2 restart video-maker-backend
# Or for systemd:
# sudo systemctl restart video-maker-backend
echo "Please restart your backend service manually"
echo "Example: pm2 restart video-maker-backend"
cd ..

echo -e "\n${YELLOW}Step 7: Deploy frontend build${NC}"
# Copy frontend build to web server
# Example for Nginx:
# sudo cp -r ./frontend/dist/* /var/www/html/
echo "Please deploy frontend build manually"
echo "Example: sudo cp -r ./frontend/dist/* /var/www/html/"

echo -e "\n${GREEN}=======================================${NC}"
echo -e "${GREEN}  Deployment Script Complete${NC}"
echo -e "${GREEN}=======================================${NC}"
echo ""
echo "Next steps:"
echo "1. Manually restart backend service"
echo "2. Deploy frontend build to web server"
echo "3. Run smoke tests (see deployment/smoke-tests.md)"
echo "4. Monitor logs for errors"
echo ""
echo "Backup location: $BACKUP_DIR"
```

```bash
chmod +x deployment/deploy-v1.1.sh
```

### 3. 创建回滚脚本

**文件**: `deployment/rollback-v1.1.sh`

```bash
#!/bin/bash

echo "======================================="
echo "  v1.1 Rollback Script"
echo "======================================="

set -e

# Configuration
BACKUP_DIR=""  # Will be provided as argument
DB_NAME="video-maker"

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

# Check if backup directory provided
if [ -z "$1" ]; then
  echo -e "${RED}Error: Please provide backup directory${NC}"
  echo "Usage: ./rollback-v1.1.sh <backup-directory>"
  echo "Example: ./rollback-v1.1.sh ./backups/v1.1-20250115-140000"
  exit 1
fi

BACKUP_DIR="$1"

if [ ! -d "$BACKUP_DIR" ]; then
  echo -e "${RED}Error: Backup directory not found: $BACKUP_DIR${NC}"
  exit 1
fi

echo -e "${YELLOW}WARNING: This will rollback to v1.0${NC}"
echo "Backup directory: $BACKUP_DIR"
read -p "Are you sure? (yes/no): " -r
if [[ ! $REPLY =~ ^yes$ ]]; then
  echo "Rollback cancelled"
  exit 0
fi

echo -e "\n${YELLOW}Step 1: Restore database${NC}"
mongorestore --db=$DB_NAME --drop "$BACKUP_DIR/$DB_NAME"
echo -e "${GREEN}✓ Database restored${NC}"

echo -e "\n${YELLOW}Step 2: Checkout v1.0 code${NC}"
git checkout v1.0  # Or specific commit hash
echo -e "${GREEN}✓ Code reverted to v1.0${NC}"

echo -e "\n${YELLOW}Step 3: Reinstall dependencies${NC}"
cd backend && npm ci && cd ..
cd frontend && npm ci && cd ..
echo -e "${GREEN}✓ Dependencies reinstalled${NC}"

echo -e "\n${YELLOW}Step 4: Rebuild frontend${NC}"
cd frontend && npm run build && cd ..
echo -e "${GREEN}✓ Frontend rebuilt${NC}"

echo -e "\n${RED}=======================================${NC}"
echo -e "${RED}  Rollback Complete${NC}"
echo -e "${RED}=======================================${NC}"
echo ""
echo "Next steps:"
echo "1. Restart backend service"
echo "2. Redeploy frontend"
echo "3. Verify application is working"
```

```bash
chmod +x deployment/rollback-v1.1.sh
```

### 4. 创建烟雾测试清单

**文件**: `deployment/smoke-tests.md`

```markdown
# v1.1 Smoke Tests

Run these tests immediately after deployment to verify basic functionality.

## Backend Health Check

### 1. Server is running
```bash
curl http://your-domain.com/health
# Expected: { "status": "ok" }
```

### 2. Database connection
```bash
curl http://your-domain.com/api/workspaces
# Expected: Array of workspaces (may be empty)
```

### 3. WebSocket connection
Open browser console:
```javascript
const ws = new WebSocket('ws://your-domain.com:3001');
ws.onopen = () => console.log('✓ WebSocket connected');
ws.onerror = (err) => console.error('✗ WebSocket error', err);
```

## Frontend Health Check

### 1. Page loads
- [ ] Navigate to http://your-domain.com
- [ ] No JavaScript errors in console
- [ ] UI renders correctly

### 2. Create workspace
- [ ] Click `+` button
- [ ] New workspace appears
- [ ] No errors in console

### 3. Upload image
- [ ] Click upload button
- [ ] Select an image
- [ ] Image displays correctly

### 4. v1.1 Form fields
- [ ] Duration dropdown has 4 options
- [ ] Aspect ratio selector has 4 buttons
- [ ] Motion intensity slider works
- [ ] Quality preset dropdown has 3 options

### 5. Generate video
- [ ] Fill all fields
- [ ] Click "Generate Video"
- [ ] Status changes to "generating"
- [ ] Video completes successfully (wait 2-5 min)
- [ ] Video plays in player

### 6. Load old workspace (if any)
- [ ] Refresh page
- [ ] Old workspaces load
- [ ] v1.1 fields show default values
- [ ] Can modify and save

## Performance Check

### 1. Response times
- [ ] Page load < 2 seconds
- [ ] API response < 500ms
- [ ] WebSocket message < 500ms

### 2. No memory leaks
- [ ] Check browser memory in DevTools
- [ ] Create/delete 10 workspaces
- [ ] Memory returns to baseline

## Rollback Triggers

Roll back immediately if:
- ❌ Server doesn't start
- ❌ Database connection fails
- ❌ >50% of video generations fail
- ❌ Page doesn't load
- ❌ Critical functionality broken
- ❌ Data corruption detected
```

### 5. 创建监控配置（可选）

**文件**: `deployment/monitoring-config.md`

```markdown
# v1.1 Monitoring Configuration

## Log Monitoring

### Important log patterns to watch:

**Errors**:
```bash
tail -f backend/logs/error.log | grep "v1.1"
```

**Video generation**:
```bash
tail -f backend/logs/combined.log | grep "Video generation request"
```

**WebSocket connections**:
```bash
tail -f backend/logs/combined.log | grep "WebSocket"
```

## Metrics to Track

### Application Metrics
- **Video generation success rate**: Target >95%
- **Average generation time**:
  - Draft: <60s
  - Standard: <180s
  - High: <300s
- **WebSocket connection rate**: Monitor reconnections

### Performance Metrics
- **API response time**: Target <500ms (p95)
- **Frontend load time**: Target <2s
- **Database query time**: Target <100ms

### Error Metrics
- **4xx errors**: Should be <5% of requests
- **5xx errors**: Should be <1% of requests
- **WebSocket errors**: Monitor disconnection rate

## Alert Rules (optional)

Configure alerts for:
- [ ] Server down (no /health response)
- [ ] Database connection失败
- [ ] Error rate >5%
- [ ] Video generation failure rate >20%
- [ ] Disk space <10%
- [ ] Memory usage >90%

## Health Dashboard (optional)

Consider setting up:
- Grafana dashboard
- Prometheus metrics
- Uptime monitoring (UptimeRobot, Pingdom)
```

### 6. 创建部署文档

**文件**: `deployment/DEPLOYMENT_GUIDE_v1.1.md`

```markdown
# v1.1 Deployment Guide

## Prerequisites

- Node.js v18+
- MongoDB v6+
- Git access
- Production server access
- Valid API keys (Qwen, Gemini)

## Deployment Steps

### 1. Pre-deployment
```bash
# 1.1 Review checklist
cat deployment/v1.1-pre-deployment-checklist.md

# 1.2 Run tests locally
cd backend && npm test
cd frontend && npm test

# 1.3 Commit all changes
git add .
git commit -m "v1.1 release"
git push origin main
```

### 2. Backup
```bash
# 2.1 Backup database
mongodump --db=video-maker --out=./backup-$(date +%Y%m%d)

# 2.2 Backup code
git tag v1.0-pre-v1.1
git push origin v1.0-pre-v1.1
```

### 3. Deploy
```bash
# 3.1 Pull latest code on server
ssh user@your-server
cd /path/to/app
git pull origin main

# 3.2 Run deployment script
./deployment/deploy-v1.1.sh
```

### 4. Post-deployment
```bash
# 4.1 Run smoke tests
# Follow: deployment/smoke-tests.md

# 4.2 Monitor logs
tail -f backend/logs/combined.log

# 4.3 Check error rate
# Monitor error.log for 30 minutes
```

### 5. Verify
- [ ] Test video generation with all parameter combinations
- [ ] Verify old workspaces load correctly
- [ ] Test on mobile devices
- [ ] Check performance metrics

## Rollback Procedure

If issues detected:

```bash
# 1. Run rollback script
./deployment/rollback-v1.1.sh ./backups/v1.1-YYYYMMDD-HHMMSS

# 2. Notify team
# Inform stakeholders of rollback

# 3. Investigate
# Review logs and error reports

# 4. Fix and redeploy
# Fix issues and retry deployment
```

## Troubleshooting

### Issue: Database migration fails
**Solution**: Check MongoDB version, review migration script logs

### Issue: Frontend build fails
**Solution**: Clear node_modules, reinstall dependencies

### Issue: WebSocket connection fails
**Solution**: Check firewall, verify port 3001 is open

### Issue: Video generation fails
**Solution**: Verify API keys, check Qwen API status
```

### 7. 执行最终检查

运行所有检查清单项：

```bash
# 代码质量检查
git status
npm run lint:backend
npm run type-check:frontend

# 测试
cd backend && npm test
cd frontend && npm test

# 安全审计
npm audit
```

## 验收标准

- [ ] Pre-deployment checklist完成
- [ ] 部署脚本已创建并测试
- [ ] 回滚脚本已创建并测试
- [ ] 烟雾测试清单已创建
- [ ] 监控配置文档已创建
- [ ] 部署指南完整
- [ ] 所有脚本有执行权限
- [ ] 备份策略已确认
- [ ] 团队已知晓部署流程
- [ ] 回滚条件已定义

## 输出物

1. `deployment/v1.1-pre-deployment-checklist.md`
2. `deployment/deploy-v1.1.sh`
3. `deployment/rollback-v1.1.sh`
4. `deployment/smoke-tests.md`
5. `deployment/monitoring-config.md`
6. `deployment/DEPLOYMENT_GUIDE_v1.1.md`

## 部署时间表建议

**推荐部署时间**：
- 周二或周三（避免周一和周五）
- 非业务高峰期
- 团队全员在线
- 至少预留2小时

**部署窗口**：
1. T+0: 开始部署
2. T+30min: 完成部署
3. T+30min ~ T+2h: 监控期
4. T+2h: 如无问题，宣布成功

**回滚窗口**：
- 如果T+30min内发现严重问题，立即回滚
- 如果T+2h内发现重大问题，考虑回滚

## 部署后监控期

### 第一小时
- 每5分钟检查错误日志
- 监控视频生成成功率
- 查看用户反馈

### 第2-24小时
- 每小时检查关键指标
- 收集用户反馈
- 记录任何异常

### 第2-7天
- 每日检查指标报告
- 收集功能使用数据
- 准备v1.1报告

## 完成标志

- ✅ v1.1成功部署到生产环境
- ✅ 所有烟雾测试通过
- ✅ 监控正常，无严重错误
- ✅ 用户可以正常使用新功能
- ✅ 向后兼容性验证通过

## 下一步

- 收集用户反馈
- 监控性能指标
- 规划v1.2功能

## 预计耗时
2 小时（准备）+ 2小时（部署和监控）

## 依赖任务
- v1.1-7.1-update-documentation.md
