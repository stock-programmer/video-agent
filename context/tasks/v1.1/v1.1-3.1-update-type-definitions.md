# v1.1 ä»»åŠ¡ 3.1 - æ›´æ–°TypeScriptç±»å‹å®šä¹‰

## å±‚çº§
ç¬¬3å±‚ - ä¾èµ– Layer 1

## å¹¶è¡Œä»»åŠ¡
- v1.1-2.1-update-database-schema.md (å¯åŒæ—¶è¿›è¡Œ)

## ä»»åŠ¡ç›®æ ‡
åœ¨å‰ç«¯TypeScriptç±»å‹å®šä¹‰ä¸­æ·»åŠ v1.1æ–°å¢çš„4ä¸ªè¡¨å•å­—æ®µï¼Œç¡®ä¿ç±»å‹å®‰å…¨å’ŒIDEæ™ºèƒ½æç¤ºã€‚

## å‰ç½®æ¡ä»¶
- ä»»åŠ¡ 1.1 å·²å®Œæˆï¼ˆäº†è§£å‚æ•°ç»“æ„ï¼‰

## æ‰§è¡Œæ­¥éª¤

### 1. æ›´æ–°VideoFormDataæ¥å£
**æ–‡ä»¶**: `frontend/src/types/workspace.ts`

æ‰¾åˆ° `VideoFormData` æ¥å£ï¼Œæ·»åŠ æ–°å­—æ®µï¼š

```typescript
// frontend/src/types/workspace.ts

export interface VideoFormData {
  // ===== v1.0 å­—æ®µ =====
  camera_movement: string;
  shot_type: string;
  lighting: string;
  motion_prompt: string;
  checkboxes: Record<string, boolean>;

  // ===== v1.1 æ–°å¢å­—æ®µ =====
  // âš ï¸ æ³¨æ„: durationå€¼åŸºäºQwen APIéªŒè¯ç»“æœï¼ˆå‚è§v1.1-1.1ä»»åŠ¡æŠ¥å‘Šï¼‰
  duration: number;              // 5, 10, 15 (seconds) - Qwen APIæ”¯æŒçš„å€¼
  aspect_ratio: AspectRatio;     // '16:9' | '9:16' | '1:1' | '4:3'
  motion_intensity: number;      // 1-5 scale
  quality_preset: QualityPreset; // 'draft' | 'standard' | 'high'
}

// ===== v1.1 æ–°å¢ç±»å‹å®šä¹‰ =====

/**
 * è§†é¢‘æ—¶é•¿é€‰é¡¹ï¼ˆç§’ï¼‰
 * âš ï¸ æ³¨æ„: åŸºäºQwen wan2.6-i2v APIçš„å®é™…æ”¯æŒå€¼
 */
export type Duration = 5 | 10 | 15;

/**
 * è§†é¢‘å®½é«˜æ¯”
 */
export type AspectRatio = '16:9' | '9:16' | '1:1' | '4:3';

/**
 * è¿åŠ¨å¼ºåº¦ç­‰çº§ (1=æœ€ä½, 5=æœ€é«˜)
 */
export type MotionIntensity = 1 | 2 | 3 | 4 | 5;

/**
 * è´¨é‡é¢„è®¾
 */
export type QualityPreset = 'draft' | 'standard' | 'high';

// ===== å¸¸é‡å®šä¹‰ï¼ˆç”¨äºä¸‹æ‹‰æ¡†/é€‰æ‹©å™¨ï¼‰ =====

/**
 * æ—¶é•¿é€‰é¡¹åˆ—è¡¨
 */
export const DURATION_OPTIONS: readonly Duration[] = [5, 10, 15] as const;

/**
 * æ—¶é•¿é€‰é¡¹å…ƒæ•°æ®
 */
export const DURATION_OPTIONS_META: Array<{
  value: Duration;
  label: string;
  description: string;
}> = [
  { value: 5, label: '5ç§’', description: 'çŸ­è§†é¢‘ç‰‡æ®µ' },
  { value: 10, label: '10ç§’', description: 'æ ‡å‡†åœºæ™¯é•¿åº¦' },
  { value: 15, label: '15ç§’', description: 'æ‰©å±•å™äº‹ç‰‡æ®µ' }
];

/**
 * å®½é«˜æ¯”é€‰é¡¹åˆ—è¡¨
 */
export const ASPECT_RATIO_OPTIONS: readonly AspectRatio[] = [
  '16:9',
  '9:16',
  '1:1',
  '4:3'
] as const;

/**
 * å®½é«˜æ¯”é€‰é¡¹å…ƒæ•°æ®
 */
export const ASPECT_RATIO_OPTIONS_META: Array<{
  value: AspectRatio;
  label: string;
  description: string;
  icon: string;
}> = [
  {
    value: '16:9',
    label: 'æ¨ªå± 16:9',
    description: 'YouTube, ä¼ ç»Ÿè§†é¢‘',
    icon: 'ğŸ–¥ï¸'
  },
  {
    value: '9:16',
    label: 'ç«–å± 9:16',
    description: 'TikTok, Reels, Stories',
    icon: 'ğŸ“±'
  },
  {
    value: '1:1',
    label: 'æ–¹å½¢ 1:1',
    description: 'Instagramå¸–å­',
    icon: 'â—»ï¸'
  },
  {
    value: '4:3',
    label: 'ç»å…¸ 4:3',
    description: 'ä¼ ç»Ÿç”µè§†æ ¼å¼',
    icon: 'ğŸ“º'
  }
];

/**
 * è¿åŠ¨å¼ºåº¦ç­‰çº§
 */
export const MOTION_INTENSITY_LEVELS: readonly MotionIntensity[] = [
  1, 2, 3, 4, 5
] as const;

/**
 * è¿åŠ¨å¼ºåº¦æ ‡ç­¾
 */
export const MOTION_INTENSITY_LABELS: Record<MotionIntensity, string> = {
  1: 'ææ…¢',
  2: 'æ…¢é€Ÿ',
  3: 'ä¸­ç­‰',
  4: 'å¿«é€Ÿ',
  5: 'æå¿«'
};

/**
 * è¿åŠ¨å¼ºåº¦æè¿°
 */
export const MOTION_INTENSITY_DESCRIPTIONS: Record<MotionIntensity, string> = {
  1: 'å¾®å¦™å˜åŒ–ï¼Œå‡ ä¹é™æ­¢',
  2: 'ç¼“æ…¢ç§»åŠ¨ï¼Œå¹³é™æ°›å›´',
  3: 'è‡ªç„¶èŠ‚å¥ï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯',
  4: 'æ´»è·ƒåŠ¨æ„Ÿï¼Œé€‚åˆåŠ¨ä½œåœºæ™¯',
  5: 'æé«˜åŠ¨æ€ï¼Œå¿«é€Ÿè¿åŠ¨'
};

/**
 * è´¨é‡é¢„è®¾é€‰é¡¹åˆ—è¡¨
 */
export const QUALITY_PRESET_OPTIONS: readonly QualityPreset[] = [
  'draft',
  'standard',
  'high'
] as const;

/**
 * è´¨é‡é¢„è®¾å…ƒæ•°æ®
 */
export const QUALITY_PRESET_OPTIONS_META: Array<{
  value: QualityPreset;
  label: string;
  description: string;
  resolution: string;
  estimatedTime: string;
}> = [
  {
    value: 'draft',
    label: 'è‰ç¨¿',
    description: 'å¿«é€Ÿé¢„è§ˆ',
    resolution: '720p',
    estimatedTime: '~1åˆ†é’Ÿ'
  },
  {
    value: 'standard',
    label: 'æ ‡å‡†',
    description: 'æ¨è',
    resolution: '1080p',
    estimatedTime: '~2åˆ†é’Ÿ'
  },
  {
    value: 'high',
    label: 'é«˜æ¸…',
    description: 'æœ€ä½³è´¨é‡',
    resolution: '1080p+',
    estimatedTime: '~4åˆ†é’Ÿ'
  }
];

// ===== é»˜è®¤å€¼å¸¸é‡ =====

/**
 * v1.1 è¡¨å•å­—æ®µé»˜è®¤å€¼
 * âš ï¸ æ³¨æ„: durationé»˜è®¤å€¼ä¸º5ç§’ï¼ˆQwen APIæœ€å°å€¼ï¼‰
 */
export const DEFAULT_V1_1_FORM_DATA = {
  duration: 5 as Duration,  // APIæœ€å°å€¼
  aspect_ratio: '16:9' as AspectRatio,
  motion_intensity: 3 as MotionIntensity,
  quality_preset: 'standard' as QualityPreset
};

// ===== ä¿æŒåŸæœ‰æ¥å£ä¸å˜ =====

export interface VideoGenerationStatus {
  status: 'pending' | 'generating' | 'completed' | 'failed';
  task_id: string;
  url: string;
  error: string;
}

export interface Workspace {
  _id: string;
  order_index: number;
  image_path: string;
  image_url: string;
  form_data: VideoFormData;
  video: VideoGenerationStatus;
  ai_collaboration: Array<{
    user_input: string;
    ai_suggestion: string;
    timestamp: Date;
  }>;
  created_at: Date;
  updated_at: Date;
}
```

### 2. æ·»åŠ ç±»å‹éªŒè¯å·¥å…·å‡½æ•°
åœ¨åŒä¸€æ–‡ä»¶ä¸­æ·»åŠ ç±»å‹å®ˆå«å’ŒéªŒè¯å‡½æ•°ï¼š

```typescript
// ===== ç±»å‹å®ˆå«å‡½æ•° =====

/**
 * æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„æ—¶é•¿å€¼
 */
export function isValidDuration(value: unknown): value is Duration {
  return typeof value === 'number' && DURATION_OPTIONS.includes(value as Duration);
}

/**
 * æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„å®½é«˜æ¯”
 */
export function isValidAspectRatio(value: unknown): value is AspectRatio {
  return typeof value === 'string' && ASPECT_RATIO_OPTIONS.includes(value as AspectRatio);
}

/**
 * æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„è¿åŠ¨å¼ºåº¦
 */
export function isValidMotionIntensity(value: unknown): value is MotionIntensity {
  return typeof value === 'number' && value >= 1 && value <= 5;
}

/**
 * æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„è´¨é‡é¢„è®¾
 */
export function isValidQualityPreset(value: unknown): value is QualityPreset {
  return typeof value === 'string' && QUALITY_PRESET_OPTIONS.includes(value as QualityPreset);
}

/**
 * éªŒè¯å®Œæ•´çš„v1.1è¡¨å•æ•°æ®
 */
export function validateV1_1FormData(data: Partial<VideoFormData>): {
  valid: boolean;
  errors: string[];
} {
  const errors: string[] = [];

  if (data.duration !== undefined && !isValidDuration(data.duration)) {
    errors.push(`Invalid duration: ${data.duration}. Must be one of: ${DURATION_OPTIONS.join(', ')}`);
  }

  if (data.aspect_ratio !== undefined && !isValidAspectRatio(data.aspect_ratio)) {
    errors.push(`Invalid aspect_ratio: ${data.aspect_ratio}. Must be one of: ${ASPECT_RATIO_OPTIONS.join(', ')}`);
  }

  if (data.motion_intensity !== undefined && !isValidMotionIntensity(data.motion_intensity)) {
    errors.push(`Invalid motion_intensity: ${data.motion_intensity}. Must be between 1 and 5`);
  }

  if (data.quality_preset !== undefined && !isValidQualityPreset(data.quality_preset)) {
    errors.push(`Invalid quality_preset: ${data.quality_preset}. Must be one of: ${QUALITY_PRESET_OPTIONS.join(', ')}`);
  }

  return {
    valid: errors.length === 0,
    errors
  };
}

/**
 * ä¸ºæ—§çš„workspaceæ•°æ®å¡«å……v1.1é»˜è®¤å€¼
 */
export function applyV1_1Defaults(formData: Partial<VideoFormData>): VideoFormData {
  return {
    // v1.0 fields
    camera_movement: formData.camera_movement || '',
    shot_type: formData.shot_type || '',
    lighting: formData.lighting || '',
    motion_prompt: formData.motion_prompt || '',
    checkboxes: formData.checkboxes || {},
    // v1.1 fields with defaults
    duration: formData.duration ?? DEFAULT_V1_1_FORM_DATA.duration,
    aspect_ratio: formData.aspect_ratio ?? DEFAULT_V1_1_FORM_DATA.aspect_ratio,
    motion_intensity: formData.motion_intensity ?? DEFAULT_V1_1_FORM_DATA.motion_intensity,
    quality_preset: formData.quality_preset ?? DEFAULT_V1_1_FORM_DATA.quality_preset
  };
}
```

### 3. æµ‹è¯•ç±»å‹å®šä¹‰
åˆ›å»ºæµ‹è¯•æ–‡ä»¶éªŒè¯ç±»å‹å®‰å…¨ï¼š

**æ–‡ä»¶**: `frontend/src/types/workspace.test.ts`

```typescript
import {
  VideoFormData,
  Duration,
  AspectRatio,
  MotionIntensity,
  QualityPreset,
  DURATION_OPTIONS,
  isValidDuration,
  isValidAspectRatio,
  isValidMotionIntensity,
  isValidQualityPreset,
  validateV1_1FormData,
  applyV1_1Defaults
} from './workspace';

describe('v1.1 Type Definitions', () => {
  describe('Type Guards', () => {
    test('isValidDuration', () => {
      expect(isValidDuration(4)).toBe(true);
      expect(isValidDuration(10)).toBe(false);
      expect(isValidDuration('4')).toBe(false);
    });

    test('isValidAspectRatio', () => {
      expect(isValidAspectRatio('16:9')).toBe(true);
      expect(isValidAspectRatio('21:9')).toBe(false);
    });

    test('isValidMotionIntensity', () => {
      expect(isValidMotionIntensity(3)).toBe(true);
      expect(isValidMotionIntensity(0)).toBe(false);
      expect(isValidMotionIntensity(6)).toBe(false);
    });

    test('isValidQualityPreset', () => {
      expect(isValidQualityPreset('standard')).toBe(true);
      expect(isValidQualityPreset('ultra')).toBe(false);
    });
  });

  describe('Validation', () => {
    test('validateV1_1FormData - valid data', () => {
      const result = validateV1_1FormData({
        duration: 4,
        aspect_ratio: '16:9',
        motion_intensity: 3,
        quality_preset: 'standard'
      });

      expect(result.valid).toBe(true);
      expect(result.errors).toHaveLength(0);
    });

    test('validateV1_1FormData - invalid duration', () => {
      const result = validateV1_1FormData({
        duration: 10 as Duration
      });

      expect(result.valid).toBe(false);
      expect(result.errors).toContain(expect.stringContaining('Invalid duration'));
    });
  });

  describe('Defaults', () => {
    test('applyV1_1Defaults - fills missing fields', () => {
      const oldData: Partial<VideoFormData> = {
        camera_movement: 'push',
        motion_prompt: 'test'
      };

      const result = applyV1_1Defaults(oldData);

      expect(result.duration).toBe(4);
      expect(result.aspect_ratio).toBe('16:9');
      expect(result.motion_intensity).toBe(3);
      expect(result.quality_preset).toBe('standard');
      expect(result.camera_movement).toBe('push');
    });
  });
});
```

### 4. è¿è¡ŒTypeScriptç¼–è¯‘æ£€æŸ¥
```bash
cd frontend
npm run type-check  # æˆ– npx tsc --noEmit
```

ç¡®ä¿æ²¡æœ‰ç±»å‹é”™è¯¯ã€‚

### 5. è¿è¡Œç±»å‹æµ‹è¯•
```bash
cd frontend
npm test workspace.test.ts
```

## éªŒæ”¶æ ‡å‡†

- [ ] `VideoFormData` æ¥å£å·²æ›´æ–°ï¼ŒåŒ…å«4ä¸ªæ–°å­—æ®µ
- [ ] ä¸ºæ¯ä¸ªæ–°å­—æ®µåˆ›å»ºäº†ä¸“é—¨çš„ç±»å‹ï¼ˆDuration, AspectRatioç­‰ï¼‰
- [ ] åˆ›å»ºäº†å¸¸é‡æ•°ç»„ï¼ˆDURATION_OPTIONSç­‰ï¼‰ä¾›UIç»„ä»¶ä½¿ç”¨
- [ ] åˆ›å»ºäº†å…ƒæ•°æ®å¯¹è±¡ï¼ˆ*_METAï¼‰åŒ…å«æ ‡ç­¾å’Œæè¿°
- [ ] æ·»åŠ äº†é»˜è®¤å€¼å¸¸é‡ `DEFAULT_V1_1_FORM_DATA`
- [ ] å®ç°äº†ç±»å‹å®ˆå«å‡½æ•°ï¼ˆisValid*ï¼‰
- [ ] å®ç°äº†éªŒè¯å‡½æ•° `validateV1_1FormData`
- [ ] å®ç°äº†é»˜è®¤å€¼å¡«å……å‡½æ•° `applyV1_1Defaults`
- [ ] TypeScriptç¼–è¯‘æ— é”™è¯¯
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] IDEæ™ºèƒ½æç¤ºå·¥ä½œæ­£å¸¸ï¼ˆæµ‹è¯•è‡ªåŠ¨è¡¥å…¨ï¼‰

## è¾“å‡ºç‰©

1. æ›´æ–°çš„ç±»å‹å®šä¹‰ï¼š`frontend/src/types/workspace.ts`
2. ç±»å‹æµ‹è¯•æ–‡ä»¶ï¼š`frontend/src/types/workspace.test.ts`
3. TypeScriptç¼–è¯‘æŠ¥å‘Šï¼ˆæ— é”™è¯¯ï¼‰

## ä¸‹ä¸€æ­¥

- v1.1-4.1-update-video-form.md (å‰ç«¯è¡¨å•ç»„ä»¶æ›´æ–°)
- v1.1-4.2-update-workspace-store.md (Zustand storeæ›´æ–°)

## é¢„è®¡è€—æ—¶
2 å°æ—¶

## ä¾èµ–ä»»åŠ¡
- v1.1-1.1-verify-qwen-api.mdï¼ˆäº†è§£å‚æ•°ç»“æ„ï¼‰
