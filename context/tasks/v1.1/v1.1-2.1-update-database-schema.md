# v1.1 任务 2.1 - 更新MongoDB数据库Schema

## 层级
第2层 - 依赖 Layer 1

## 并行任务
- v1.1-3.1-update-type-definitions.md (可同时进行)

## 任务目标
在Workspace Schema中添加v1.1新增的4个表单字段，并设置默认值以确保向后兼容性。

## 前置条件
- 任务 1.1 已完成（了解API参数映射）
- MongoDB服务运行中

## 执行步骤

### 1. 备份现有数据库（可选但推荐）
```bash
# 导出现有workspaces数据
mongodump --db=video-maker --collection=workspaces --out=./backup/pre-v1.1

# 或导出为JSON
mongoexport --db=video-maker --collection=workspaces --out=workspaces-backup.json
```

### 2. 更新Workspace Schema
**文件**: `backend/src/db/mongodb.js`

找到 `form_data` 字段定义，添加新字段：

```javascript
const WorkspaceSchema = new mongoose.Schema({
  order_index: {
    type: Number,
    required: true,
    unique: true
  },
  image_path: {
    type: String,
    default: ''
  },
  image_url: {
    type: String,
    default: ''
  },
  form_data: {
    // ===== v1.0 字段 =====
    camera_movement: {
      type: String,
      default: ''
    },
    shot_type: {
      type: String,
      default: ''
    },
    lighting: {
      type: String,
      default: ''
    },
    motion_prompt: {
      type: String,
      default: ''
    },
    checkboxes: {
      type: Object,
      default: {}
    },

    // ===== v1.1 新增字段 =====
    // ⚠️ 注意: duration值基于Qwen API验证结果（参见v1.1-1.1任务报告）
    duration: {
      type: Number,
      default: 5,  // 默认5秒（API最小值）
      enum: [5, 10, 15],  // Qwen API仅支持这3个值
      required: false  // 向后兼容v1.0
    },
    aspect_ratio: {
      type: String,
      default: '16:9',  // 默认16:9
      enum: ['16:9', '9:16', '1:1', '4:3'],
      required: false
    },
    motion_intensity: {
      type: Number,
      default: 3,  // 默认中等强度
      min: 1,
      max: 5,
      required: false
    },
    quality_preset: {
      type: String,
      default: 'standard',  // 默认标准质量
      enum: ['draft', 'standard', 'high'],
      required: false
    }
  },
  video: {
    status: {
      type: String,
      enum: ['pending', 'generating', 'completed', 'failed'],
      default: 'pending'
    },
    task_id: {
      type: String,
      default: ''
    },
    url: {
      type: String,
      default: ''
    },
    error: {
      type: String,
      default: ''
    }
  },
  ai_collaboration: {
    type: Array,
    default: []
  },
  created_at: {
    type: Date,
    default: Date.now
  },
  updated_at: {
    type: Date,
    default: Date.now
  }
});

// 更新时自动更新 updated_at
WorkspaceSchema.pre('save', function(next) {
  this.updated_at = Date.now();
  next();
});

WorkspaceSchema.pre('findOneAndUpdate', function(next) {
  this.set({ updated_at: Date.now() });
  next();
});
```

### 3. 创建数据库迁移脚本（可选）
**文件**: `backend/migrate-v1-1.js`

```javascript
const mongoose = require('mongoose');
require('dotenv').config();

const MONGODB_URI = process.env.MONGODB_URI || 'mongodb://localhost:27017/video-maker';

async function migrateToV1_1() {
  console.log('=== v1.1 数据库迁移脚本 ===\n');

  try {
    // 连接数据库
    await mongoose.connect(MONGODB_URI);
    console.log('✅ 数据库连接成功');

    const db = mongoose.connection.db;
    const workspaces = db.collection('workspaces');

    // 查找缺少v1.1字段的workspace
    const oldWorkspaces = await workspaces.countDocuments({
      'form_data.duration': { $exists: false }
    });

    console.log(`\n找到 ${oldWorkspaces} 个需要迁移的workspace`);

    if (oldWorkspaces === 0) {
      console.log('✅ 没有需要迁移的数据');
      return;
    }

    // 更新所有旧workspace
    const result = await workspaces.updateMany(
      { 'form_data.duration': { $exists: false } },
      {
        $set: {
          'form_data.duration': 5,            // API最小值
          'form_data.aspect_ratio': '16:9',
          'form_data.motion_intensity': 3,
          'form_data.quality_preset': 'standard'
        }
      }
    );

    console.log(`\n✅ 迁移完成！`);
    console.log(`   修改的文档数: ${result.modifiedCount}`);

    // 验证迁移结果
    const updatedWorkspaces = await workspaces.find({
      'form_data.duration': { $exists: true }
    }).toArray();

    console.log(`\n✅ 验证: 现在有 ${updatedWorkspaces.length} 个workspace包含v1.1字段`);

    // 显示第一个迁移后的workspace示例
    if (updatedWorkspaces.length > 0) {
      console.log('\n示例workspace (form_data):');
      console.log(JSON.stringify(updatedWorkspaces[0].form_data, null, 2));
    }

  } catch (error) {
    console.error('❌ 迁移失败:', error);
    process.exit(1);
  } finally {
    await mongoose.connection.close();
    console.log('\n数据库连接已关闭');
  }
}

// 运行迁移
migrateToV1_1().then(() => {
  console.log('\n=== 迁移完成 ===');
  process.exit(0);
});
```

### 4. 测试Schema更新

**测试1: 创建新workspace（包含v1.1字段）**
```javascript
// backend/test-create-workspace-v1.1.js
const mongoose = require('mongoose');
const { Workspace } = require('./src/db/mongodb');
require('dotenv').config();

async function testCreate() {
  await mongoose.connect(process.env.MONGODB_URI);

  const workspace = new Workspace({
    order_index: 999,
    image_path: '/uploads/test.jpg',
    image_url: '/uploads/test.jpg',
    form_data: {
      camera_movement: 'push',
      shot_type: 'medium',
      lighting: 'natural',
      motion_prompt: 'Test motion',
      checkboxes: {},
      // v1.1 新字段
      duration: 15,           // 5, 10, or 15 (Qwen API支持的值)
      aspect_ratio: '9:16',
      motion_intensity: 5,
      quality_preset: 'high'
    }
  });

  await workspace.save();
  console.log('✅ 创建成功:', workspace.toObject());

  await mongoose.connection.close();
}

testCreate().catch(console.error);
```

**测试2: 加载旧workspace（验证默认值）**
```javascript
// backend/test-load-old-workspace.js
const mongoose = require('mongoose');
const { Workspace } = require('./src/db/mongodb');
require('dotenv').config();

async function testLoad() {
  await mongoose.connect(process.env.MONGODB_URI);

  // 假设有一个v1.0的workspace（没有v1.1字段）
  const oldWorkspace = await Workspace.findOne({ 'form_data.duration': { $exists: false } });

  if (oldWorkspace) {
    console.log('加载旧workspace:', oldWorkspace._id);
    console.log('form_data:', oldWorkspace.form_data);

    // 检查默认值
    console.log('\n默认值检查:');
    console.log('duration:', oldWorkspace.form_data.duration || '❌ 未设置');
    console.log('aspect_ratio:', oldWorkspace.form_data.aspect_ratio || '❌ 未设置');
    console.log('motion_intensity:', oldWorkspace.form_data.motion_intensity || '❌ 未设置');
    console.log('quality_preset:', oldWorkspace.form_data.quality_preset || '❌ 未设置');
  } else {
    console.log('✅ 没有找到v1.0 workspace（都已迁移或是新创建的）');
  }

  await mongoose.connection.close();
}

testLoad().catch(console.error);
```

### 5. 运行迁移（如果需要）
```bash
cd backend
node migrate-v1-1.js
```

### 6. 验证数据库
```bash
# 使用mongosh验证
mongosh

use video-maker
db.workspaces.findOne({}, { form_data: 1 })

# 应该看到新增的4个字段：duration, aspect_ratio, motion_intensity, quality_preset
```

## 验收标准

- [ ] `backend/src/db/mongodb.js` 已更新，包含4个新字段
- [ ] 所有新字段都设置了默认值
- [ ] 新字段设置了 `required: false` 以确保向后兼容
- [ ] 使用enum限制了允许的值
- [ ] 迁移脚本已创建（如果需要）
- [ ] 测试脚本已运行，验证：
  - [ ] 新workspace可以保存v1.1字段
  - [ ] 旧workspace可以正常加载
  - [ ] 旧workspace自动应用默认值
- [ ] 数据库中至少有1个包含v1.1字段的workspace
- [ ] 没有数据丢失或损坏

## 输出物

1. 更新的Schema文件：`backend/src/db/mongodb.js`
2. 迁移脚本（可选）：`backend/migrate-v1-1.js`
3. 测试脚本：`backend/test-create-workspace-v1.1.js`
4. 验证报告（记录测试结果）

## 回滚方案

如果迁移出现问题：

```bash
# 恢复备份
mongorestore --db=video-maker --collection=workspaces ./backup/pre-v1.1/video-maker/workspaces.bson

# 或从JSON恢复
mongoimport --db=video-maker --collection=workspaces --file=workspaces-backup.json --drop
```

## 下一步

- v1.1-4.1-update-video-form.md (前端表单更新)
- v1.1-5.1-update-generate-video-api.md (后端API更新)

## 预计耗时
3 小时

## 依赖任务
- v1.1-1.1-verify-qwen-api.md（完成后才知道确切的参数映射）
