# v1.1 任务 5.2 - 更新WebSocket处理器

## 层级
第5层 - 依赖 Layer 2

## 并行任务
- v1.1-5.1-update-generate-video-api.md (可同时进行)

## 任务目标
更新WebSocket workspace处理器，确保创建和更新workspace时能够正确保存v1.1新字段。

## 前置条件
- 任务 2.1 已完成（数据库Schema更新）

## 执行步骤

### 1. 更新workspace-create处理器
**文件**: `backend/src/websocket/workspace-create.js`

```javascript
const { Workspace } = require('../db/mongodb');
const logger = require('../utils/logger');

/**
 * v1.1: Default values for new fields
 */
const V1_1_DEFAULTS = {
  duration: 4,
  aspect_ratio: '16:9',
  motion_intensity: 3,
  quality_preset: 'standard'
};

async function handleWorkspaceCreate(ws, data, broadcastToClient) {
  try {
    const { form_data = {}, image_path = '', image_url = '' } = data;

    // ===== v1.1: 合并默认值 =====
    const completeFormData = {
      // v1.0 fields
      camera_movement: form_data.camera_movement || '',
      shot_type: form_data.shot_type || '',
      lighting: form_data.lighting || '',
      motion_prompt: form_data.motion_prompt || '',
      checkboxes: form_data.checkboxes || {},

      // v1.1 fields (merge with defaults)
      duration: form_data.duration ?? V1_1_DEFAULTS.duration,
      aspect_ratio: form_data.aspect_ratio ?? V1_1_DEFAULTS.aspect_ratio,
      motion_intensity: form_data.motion_intensity ?? V1_1_DEFAULTS.motion_intensity,
      quality_preset: form_data.quality_preset ?? V1_1_DEFAULTS.quality_preset
    };

    // ===== v1.1: 参数验证 =====
    const validationErrors = validateV1_1Fields(completeFormData);
    if (validationErrors.length > 0) {
      logger.warn('Invalid v1.1 fields in workspace create', { errors: validationErrors });
      broadcastToClient(ws, {
        type: 'error',
        data: {
          message: 'Invalid form data',
          errors: validationErrors
        }
      });
      return;
    }

    // 获取新的order_index
    const maxOrder = await Workspace.findOne()
      .sort({ order_index: -1 })
      .select('order_index')
      .lean();
    const newOrderIndex = (maxOrder?.order_index ?? -1) + 1;

    // 创建workspace
    const newWorkspace = new Workspace({
      order_index: newOrderIndex,
      image_path,
      image_url,
      form_data: completeFormData,
      video: {
        status: 'pending',
        task_id: '',
        url: '',
        error: ''
      },
      ai_collaboration: []
    });

    await newWorkspace.save();

    logger.info('Workspace created with v1.1 fields', {
      workspace_id: newWorkspace._id,
      duration: completeFormData.duration,
      aspect_ratio: completeFormData.aspect_ratio,
      motion_intensity: completeFormData.motion_intensity,
      quality_preset: completeFormData.quality_preset
    });

    // 发送确认
    broadcastToClient(ws, {
      type: 'workspace.sync_confirm',
      data: newWorkspace.toObject()
    });

  } catch (error) {
    logger.error('Workspace create failed', { error: error.message, stack: error.stack });
    broadcastToClient(ws, {
      type: 'error',
      data: { message: 'Failed to create workspace', details: error.message }
    });
  }
}

/**
 * v1.1: Validate new fields
 */
function validateV1_1Fields(formData) {
  const errors = [];

  // Validate duration
  if (formData.duration !== undefined && ![2, 4, 6, 8].includes(formData.duration)) {
    errors.push(`Invalid duration: ${formData.duration}. Must be 2, 4, 6, or 8.`);
  }

  // Validate aspect_ratio
  if (formData.aspect_ratio !== undefined && !['16:9', '9:16', '1:1', '4:3'].includes(formData.aspect_ratio)) {
    errors.push(`Invalid aspect_ratio: ${formData.aspect_ratio}. Must be 16:9, 9:16, 1:1, or 4:3.`);
  }

  // Validate motion_intensity
  if (formData.motion_intensity !== undefined) {
    if (typeof formData.motion_intensity !== 'number' || formData.motion_intensity < 1 || formData.motion_intensity > 5) {
      errors.push(`Invalid motion_intensity: ${formData.motion_intensity}. Must be between 1 and 5.`);
    }
  }

  // Validate quality_preset
  if (formData.quality_preset !== undefined && !['draft', 'standard', 'high'].includes(formData.quality_preset)) {
    errors.push(`Invalid quality_preset: ${formData.quality_preset}. Must be draft, standard, or high.`);
  }

  return errors;
}

module.exports = { handleWorkspaceCreate };
```

### 2. 更新workspace-update处理器
**文件**: `backend/src/websocket/workspace-update.js`

```javascript
const { Workspace } = require('../db/mongodb');
const logger = require('../utils/logger');

/**
 * v1.1: Allowed form_data fields (including new v1.1 fields)
 */
const ALLOWED_FORM_FIELDS = [
  // v1.0 fields
  'camera_movement',
  'shot_type',
  'lighting',
  'motion_prompt',
  'checkboxes',
  // v1.1 fields
  'duration',
  'aspect_ratio',
  'motion_intensity',
  'quality_preset'
];

async function handleWorkspaceUpdate(ws, data, broadcastToClient) {
  try {
    const { id, form_data, image_path, image_url, video } = data;

    if (!id) {
      broadcastToClient(ws, {
        type: 'error',
        data: { message: 'workspace id is required' }
      });
      return;
    }

    const workspace = await Workspace.findById(id);
    if (!workspace) {
      broadcastToClient(ws, {
        type: 'error',
        data: { message: 'Workspace not found' }
      });
      return;
    }

    // ===== v1.1: 处理form_data增量更新 =====
    if (form_data) {
      // 验证v1.1字段
      const validationErrors = validateV1_1FieldsPartial(form_data);
      if (validationErrors.length > 0) {
        logger.warn('Invalid v1.1 fields in workspace update', { workspace_id: id, errors: validationErrors });
        broadcastToClient(ws, {
          type: 'error',
          data: {
            message: 'Invalid form data',
            errors: validationErrors
          }
        });
        return;
      }

      // 增量更新：只更新提供的字段
      for (const [key, value] of Object.entries(form_data)) {
        if (ALLOWED_FORM_FIELDS.includes(key)) {
          workspace.form_data[key] = value;
        }
      }

      workspace.markModified('form_data');
    }

    // 更新其他字段
    if (image_path !== undefined) workspace.image_path = image_path;
    if (image_url !== undefined) workspace.image_url = image_url;
    if (video !== undefined) {
      workspace.video = { ...workspace.video, ...video };
      workspace.markModified('video');
    }

    await workspace.save();

    logger.info('Workspace updated', {
      workspace_id: id,
      updated_fields: Object.keys(form_data || {})
    });

    // 发送确认
    broadcastToClient(ws, {
      type: 'workspace.sync_confirm',
      data: workspace.toObject()
    });

  } catch (error) {
    logger.error('Workspace update failed', { error: error.message, stack: error.stack });
    broadcastToClient(ws, {
      type: 'error',
      data: { message: 'Failed to update workspace', details: error.message }
    });
  }
}

/**
 * v1.1: Validate v1.1 fields (partial update)
 */
function validateV1_1FieldsPartial(formData) {
  const errors = [];

  // Only validate fields that are present
  if ('duration' in formData && ![2, 4, 6, 8].includes(formData.duration)) {
    errors.push(`Invalid duration: ${formData.duration}`);
  }

  if ('aspect_ratio' in formData && !['16:9', '9:16', '1:1', '4:3'].includes(formData.aspect_ratio)) {
    errors.push(`Invalid aspect_ratio: ${formData.aspect_ratio}`);
  }

  if ('motion_intensity' in formData) {
    if (typeof formData.motion_intensity !== 'number' || formData.motion_intensity < 1 || formData.motion_intensity > 5) {
      errors.push(`Invalid motion_intensity: ${formData.motion_intensity}`);
    }
  }

  if ('quality_preset' in formData && !['draft', 'standard', 'high'].includes(formData.quality_preset)) {
    errors.push(`Invalid quality_preset: ${formData.quality_preset}`);
  }

  return errors;
}

module.exports = { handleWorkspaceUpdate };
```

### 3. workspace-delete和workspace-reorder不需要修改
这两个处理器不涉及form_data，无需更新。

### 4. 创建WebSocket测试工具
**文件**: `backend/test-websocket-v1.1.js`

```javascript
const WebSocket = require('ws');

const WS_URL = process.env.WS_URL || 'ws://localhost:3001';

async function testWebSocket() {
  console.log('=== Testing v1.1 WebSocket Handlers ===\n');

  const ws = new WebSocket(WS_URL);

  ws.on('open', () => {
    console.log('✅ WebSocket connected\n');

    // Test 1: Create workspace with v1.1 fields
    console.log('[Test 1] Creating workspace with v1.1 fields');
    ws.send(JSON.stringify({
      type: 'workspace.create',
      data: {
        form_data: {
          motion_prompt: 'Test motion',
          duration: 8,
          aspect_ratio: '9:16',
          motion_intensity: 5,
          quality_preset: 'high'
        },
        image_path: '/test.jpg',
        image_url: '/test.jpg'
      }
    }));

    // Test 2: Update workspace (incremental)
    setTimeout(() => {
      console.log('\n[Test 2] Updating duration field');
      ws.send(JSON.stringify({
        type: 'workspace.update',
        data: {
          id: 'WORKSPACE_ID_HERE',  // Replace with actual ID from Test 1
          form_data: {
            duration: 6
          }
        }
      }));
    }, 2000);

    // Test 3: Invalid value
    setTimeout(() => {
      console.log('\n[Test 3] Sending invalid duration (should fail)');
      ws.send(JSON.stringify({
        type: 'workspace.update',
        data: {
          id: 'WORKSPACE_ID_HERE',
          form_data: {
            duration: 10  // Invalid!
          }
        }
      }));
    }, 4000);

    // Close after tests
    setTimeout(() => {
      ws.close();
      console.log('\n=== Tests Complete ===');
      process.exit(0);
    }, 6000);
  });

  ws.on('message', (data) => {
    const message = JSON.parse(data.toString());
    console.log('← Received:', JSON.stringify(message, null, 2));
  });

  ws.on('error', (error) => {
    console.error('❌ WebSocket error:', error);
  });

  ws.on('close', () => {
    console.log('WebSocket closed');
  });
}

testWebSocket().catch(console.error);
```

### 5. 运行测试
```bash
# 确保后端服务运行
cd backend
npm run dev

# 在另一个终端运行WebSocket测试
node test-websocket-v1.1.js
```

### 6. 验证数据库
测试后检查MongoDB，确认v1.1字段已保存：

```bash
mongosh

use video-maker
db.workspaces.findOne({}, { form_data: 1 })

# 应该看到：
# form_data: {
#   ...v1.0 fields...,
#   duration: 8,
#   aspect_ratio: '9:16',
#   motion_intensity: 5,
#   quality_preset: 'high'
# }
```

## 验收标准

- [ ] workspace-create.js 已更新，包含v1.1默认值
- [ ] workspace-create.js 验证v1.1字段
- [ ] workspace-update.js 已更新，支持增量更新v1.1字段
- [ ] workspace-update.js 验证v1.1字段
- [ ] ALLOWED_FORM_FIELDS包含4个新字段
- [ ] WebSocket测试脚本运行成功
- [ ] 测试1（创建）：v1.1字段保存到数据库
- [ ] 测试2（更新）：增量更新成功
- [ ] 测试3（验证）：无效值被拒绝并返回错误
- [ ] 日志记录v1.1字段更新
- [ ] 向后兼容（旧客户端不发送v1.1字段时使用默认值）

## 输出物

1. 更新的WebSocket处理器：
   - `backend/src/websocket/workspace-create.js`
   - `backend/src/websocket/workspace-update.js`
2. WebSocket测试脚本：`backend/test-websocket-v1.1.js`
3. 测试报告（日志输出 + 数据库截图）

## 常见问题

### Q: 增量更新会覆盖整个form_data吗？
A: 不会。只更新提供的字段，其他字段保持不变。例如：
```javascript
// 只更新duration，其他字段不变
ws.send({
  type: 'workspace.update',
  data: {
    id: 'xxx',
    form_data: { duration: 8 }
  }
});
```

### Q: 如果客户端没有发送v1.1字段会怎样？
A: 在创建时会使用默认值。在更新时不会改变已有值。

### Q: 验证失败后数据库会回滚吗？
A: 验证在保存前进行，失败时不会写入数据库，并返回错误消息。

## 下一步

- v1.1-6.1-integration-testing.md (集成测试)

## 预计耗时
2 小时

## 依赖任务
- v1.1-2.1-update-database-schema.md（数据库Schema）
