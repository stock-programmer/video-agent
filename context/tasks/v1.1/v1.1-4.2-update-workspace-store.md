# v1.1 任务 4.2 - 更新Workspace Store

## 层级
第4层 - 依赖 Layer 3

## 并行任务
- v1.1-4.1-update-video-form.md (可同时进行)

## 任务目标
更新Zustand workspace store以支持v1.1新增字段，确保WebSocket同步和状态管理正常工作。

## 前置条件
- 任务 3.1 已完成（TypeScript类型定义）
- Zustand已配置

## 执行步骤

### 1. 更新workspaceStore的默认表单数据
**文件**: `frontend/src/stores/workspaceStore.ts`

更新默认workspace创建逻辑：

```typescript
import { create } from 'zustand';
import {
  Workspace,
  VideoFormData,
  DEFAULT_V1_1_FORM_DATA,
  applyV1_1Defaults
} from '../types/workspace';
import { wsClient } from '../services/websocket';

interface WorkspaceStore {
  workspaces: Workspace[];
  currentWorkspaceId: string | null;

  // Actions
  setWorkspaces: (workspaces: Workspace[]) => void;
  addWorkspace: () => void;
  updateWorkspace: (id: string, updates: Partial<Workspace>) => void;
  deleteWorkspace: (id: string) => void;
  reorderWorkspaces: (newOrder: string[]) => void;
  setCurrentWorkspace: (id: string | null) => void;

  // v1.1: Update form data
  updateFormData: (id: string, formData: Partial<VideoFormData>) => void;
}

export const useWorkspaceStore = create<WorkspaceStore>((set, get) => ({
  workspaces: [],
  currentWorkspaceId: null,

  setWorkspaces: (workspaces) => {
    // v1.1: Apply defaults to old workspaces that don't have v1.1 fields
    const normalizedWorkspaces = workspaces.map(ws => ({
      ...ws,
      form_data: applyV1_1Defaults(ws.form_data)
    }));
    set({ workspaces: normalizedWorkspaces });
  },

  addWorkspace: () => {
    const newWorkspace: Partial<Workspace> = {
      order_index: get().workspaces.length,
      image_path: '',
      image_url: '',
      form_data: {
        // v1.0 fields
        camera_movement: '',
        shot_type: '',
        lighting: '',
        motion_prompt: '',
        checkboxes: {},
        // v1.1 fields with defaults
        ...DEFAULT_V1_1_FORM_DATA
      },
      video: {
        status: 'pending',
        task_id: '',
        url: '',
        error: ''
      },
      ai_collaboration: []
    };

    // Send to backend via WebSocket
    wsClient.send('workspace.create', newWorkspace);
  },

  updateWorkspace: (id, updates) => {
    set((state) => ({
      workspaces: state.workspaces.map((ws) =>
        ws._id === id ? { ...ws, ...updates } : ws
      )
    }));

    // Send to backend via WebSocket
    wsClient.send('workspace.update', { id, ...updates });
  },

  updateFormData: (id, formDataUpdates) => {
    set((state) => ({
      workspaces: state.workspaces.map((ws) =>
        ws._id === id
          ? {
              ...ws,
              form_data: {
                ...ws.form_data,
                ...formDataUpdates
              }
            }
          : ws
      )
    }));

    // Send incremental update to backend via WebSocket
    wsClient.send('workspace.update', {
      id,
      form_data: formDataUpdates  // Only send changed fields
    });
  },

  deleteWorkspace: (id) => {
    set((state) => ({
      workspaces: state.workspaces.filter((ws) => ws._id !== id)
    }));

    wsClient.send('workspace.delete', { id });
  },

  reorderWorkspaces: (newOrder) => {
    set((state) => {
      const reordered = newOrder.map((id, index) => {
        const ws = state.workspaces.find((w) => w._id === id)!;
        return { ...ws, order_index: index };
      });
      return { workspaces: reordered };
    });

    wsClient.send('workspace.reorder', { order: newOrder });
  },

  setCurrentWorkspace: (id) => set({ currentWorkspaceId: id })
}));
```

### 2. 更新WebSocket消息处理

确保WebSocket客户端能够同步v1.1字段：

**文件**: `frontend/src/services/websocket.ts`

```typescript
import { useWorkspaceStore } from '../stores/workspaceStore';
import { applyV1_1Defaults } from '../types/workspace';

class WebSocketClient {
  // ... existing code ...

  private handleMessage(event: MessageEvent) {
    const message = JSON.parse(event.data);

    switch (message.type) {
      case 'workspace.sync_confirm':
        // v1.1: Apply defaults when receiving workspace from server
        const workspace = message.data;
        workspace.form_data = applyV1_1Defaults(workspace.form_data);

        useWorkspaceStore.getState().updateWorkspace(workspace._id, workspace);
        break;

      case 'video.status_update':
        const { workspace_id, video } = message.data;
        useWorkspaceStore.getState().updateWorkspace(workspace_id, { video });
        break;

      case 'error':
        console.error('WebSocket error:', message.data);
        break;

      default:
        console.warn('Unknown message type:', message.type);
    }
  }

  // ... existing code ...
}

export const wsClient = new WebSocketClient();
```

### 3. 添加表单防抖更新

为了避免频繁的WebSocket请求，对表单更新添加防抖：

```typescript
import { debounce } from 'lodash'; // 或自己实现debounce

interface WorkspaceStore {
  // ... existing ...

  // v1.1: Debounced form update
  updateFormDataDebounced: (id: string, formData: Partial<VideoFormData>) => void;
}

export const useWorkspaceStore = create<WorkspaceStore>((set, get) => ({
  // ... existing ...

  updateFormData: (id, formDataUpdates) => {
    // Immediate local update (optimistic)
    set((state) => ({
      workspaces: state.workspaces.map((ws) =>
        ws._id === id
          ? {
              ...ws,
              form_data: {
                ...ws.form_data,
                ...formDataUpdates
              }
            }
          : ws
      )
    }));
  },

  // Debounced WebSocket sync (300ms delay)
  updateFormDataDebounced: debounce((id: string, formDataUpdates: Partial<VideoFormData>) => {
    wsClient.send('workspace.update', {
      id,
      form_data: formDataUpdates
    });
  }, 300)
}));
```

然后在VideoForm中使用：

```tsx
const { updateFormData, updateFormDataDebounced } = useWorkspaceStore();

const handleChange = (field: keyof VideoFormData, value: any) => {
  // Immediate local update
  updateFormData(currentWorkspaceId, { [field]: value });

  // Debounced backend sync
  updateFormDataDebounced(currentWorkspaceId, { [field]: value });
};
```

### 4. 测试Store更新

创建测试文件：

**文件**: `frontend/src/stores/workspaceStore.test.ts`

```typescript
import { renderHook, act } from '@testing-library/react';
import { useWorkspaceStore } from './workspaceStore';
import { DEFAULT_V1_1_FORM_DATA } from '../types/workspace';

describe('workspaceStore v1.1', () => {
  beforeEach(() => {
    // Reset store before each test
    useWorkspaceStore.setState({ workspaces: [], currentWorkspaceId: null });
  });

  test('addWorkspace includes v1.1 default fields', () => {
    const { result } = renderHook(() => useWorkspaceStore());

    act(() => {
      result.current.addWorkspace();
    });

    const newWorkspace = result.current.workspaces[0];

    expect(newWorkspace.form_data.duration).toBe(DEFAULT_V1_1_FORM_DATA.duration);
    expect(newWorkspace.form_data.aspect_ratio).toBe(DEFAULT_V1_1_FORM_DATA.aspect_ratio);
    expect(newWorkspace.form_data.motion_intensity).toBe(DEFAULT_V1_1_FORM_DATA.motion_intensity);
    expect(newWorkspace.form_data.quality_preset).toBe(DEFAULT_V1_1_FORM_DATA.quality_preset);
  });

  test('setWorkspaces applies v1.1 defaults to old workspaces', () => {
    const { result } = renderHook(() => useWorkspaceStore());

    // Simulate old v1.0 workspace (no v1.1 fields)
    const oldWorkspace = {
      _id: '1',
      order_index: 0,
      image_path: '/test.jpg',
      image_url: '/test.jpg',
      form_data: {
        camera_movement: 'push',
        shot_type: 'medium',
        lighting: 'natural',
        motion_prompt: 'test',
        checkboxes: {}
        // No v1.1 fields!
      },
      video: { status: 'pending', task_id: '', url: '', error: '' },
      ai_collaboration: [],
      created_at: new Date(),
      updated_at: new Date()
    };

    act(() => {
      result.current.setWorkspaces([oldWorkspace as any]);
    });

    const workspace = result.current.workspaces[0];

    // Should have v1.1 defaults applied
    expect(workspace.form_data.duration).toBe(4);
    expect(workspace.form_data.aspect_ratio).toBe('16:9');
    expect(workspace.form_data.motion_intensity).toBe(3);
    expect(workspace.form_data.quality_preset).toBe('standard');

    // v1.0 fields should be preserved
    expect(workspace.form_data.camera_movement).toBe('push');
  });

  test('updateFormData updates specific fields', () => {
    const { result } = renderHook(() => useWorkspaceStore());

    // Create a workspace first
    act(() => {
      result.current.addWorkspace();
    });

    const workspaceId = result.current.workspaces[0]._id;

    // Update duration
    act(() => {
      result.current.updateFormData(workspaceId, { duration: 8 });
    });

    expect(result.current.workspaces[0].form_data.duration).toBe(8);

    // Update aspect_ratio
    act(() => {
      result.current.updateFormData(workspaceId, { aspect_ratio: '9:16' });
    });

    expect(result.current.workspaces[0].form_data.aspect_ratio).toBe('9:16');
    // Other fields should be unchanged
    expect(result.current.workspaces[0].form_data.duration).toBe(8);
  });

  test('updateFormData preserves v1.0 fields', () => {
    const { result } = renderHook(() => useWorkspaceStore());

    act(() => {
      result.current.addWorkspace();
    });

    const workspaceId = result.current.workspaces[0]._id;

    // Set v1.0 field
    act(() => {
      result.current.updateFormData(workspaceId, { motion_prompt: 'Test prompt' });
    });

    // Update v1.1 field
    act(() => {
      result.current.updateFormData(workspaceId, { motion_intensity: 5 });
    });

    // v1.0 field should still be there
    expect(result.current.workspaces[0].form_data.motion_prompt).toBe('Test prompt');
    expect(result.current.workspaces[0].form_data.motion_intensity).toBe(5);
  });
});
```

### 5. 运行测试

```bash
cd frontend
npm test workspaceStore.test.ts
```

确保所有测试通过。

### 6. 手动测试WebSocket同步

在浏览器中测试：

**测试步骤**：
1. 打开浏览器开发者工具 → Network → WS
2. 创建新workspace
3. 修改duration字段
4. 查看WebSocket消息，确认发送了 `workspace.update` 包含 `duration`
5. 刷新页面
6. 确认workspace加载时包含正确的duration值

**预期WebSocket消息**：
```json
// Client → Server
{
  "type": "workspace.update",
  "data": {
    "id": "workspace_id",
    "form_data": {
      "duration": 8
    }
  }
}

// Server → Client (confirmation)
{
  "type": "workspace.sync_confirm",
  "data": {
    "_id": "workspace_id",
    "form_data": {
      "duration": 8,
      "aspect_ratio": "16:9",
      // ... other fields
    }
  }
}
```

## 验收标准

- [ ] workspaceStore已更新，`addWorkspace`包含v1.1默认值
- [ ] `setWorkspaces`自动应用v1.1默认值到旧workspace
- [ ] `updateFormData`可以更新v1.1字段
- [ ] 表单更新有防抖机制（300ms）
- [ ] WebSocket消息包含v1.1字段
- [ ] 单元测试全部通过
- [ ] 手动测试WebSocket同步成功
- [ ] 刷新页面后v1.1字段保持
- [ ] 旧workspace加载时自动填充默认值
- [ ] 无TypeScript编译错误
- [ ] 无控制台错误

## 输出物

1. 更新的Store：`frontend/src/stores/workspaceStore.ts`
2. 更新的WebSocket客户端：`frontend/src/services/websocket.ts`
3. Store测试文件：`frontend/src/stores/workspaceStore.test.ts`
4. WebSocket同步测试报告（截图）

## 常见问题

### Q: 防抖会导致数据丢失吗？
A: 不会。本地state立即更新（乐观更新），只是WebSocket同步延迟300ms。如果用户快速切换字段，只会发送最终值。

### Q: 如果WebSocket断开，v1.1字段会丢失吗？
A: 不会。本地state已更新，重连后会重新同步。如果用户刷新页面，后端已有数据会被加载。

### Q: 旧workspace什么时候应用默认值？
A: 两个时机：
1. 从API加载时（`setWorkspaces`）
2. WebSocket接收时（`handleMessage`）

## 下一步

- v1.1-5.1-update-generate-video-api.md (后端API更新)
- v1.1-5.2-update-websocket-handlers.md (后端WebSocket更新)

## 预计耗时
2 小时

## 依赖任务
- v1.1-3.1-update-type-definitions.md（TypeScript类型）
