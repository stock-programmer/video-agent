# v1.1 任务 6.1 - 前后端集成测试

## 层级
第6层 - 依赖所有 Layer 4 和 Layer 5 任务

## 并行任务
无（必须等待所有前置任务完成）

## 任务目标
进行完整的端到端测试，验证v1.1新增的4个参数在整个系统中正确流转，从前端UI到后端API再到Qwen视频生成。

## 前置条件
- 所有Layer 4任务完成（前端UI和Store）
- 所有Layer 5任务完成（后端API和WebSocket）
- 前后端服务都在运行
- MongoDB服务运行
- 有效的Qwen API密钥

## 执行步骤

### 1. 启动完整环境

```bash
# Terminal 1: 启动MongoDB
sudo systemctl start mongod
mongosh --eval "db.version()"

# Terminal 2: 启动后端
cd backend
npm run dev

# Terminal 3: 启动前端
cd frontend
npm run dev
```

### 2. 测试用例1：创建新Workspace并生成视频

**目标**：验证完整流程，从创建workspace到生成视频

**步骤**：
1. 打开浏览器：`http://localhost:5173`
2. 打开开发者工具（F12）→ Console + Network
3. 点击 `+` 创建新workspace
4. 上传图片
5. 填写v1.1新字段：
   - Duration: 8秒
   - Aspect Ratio: 9:16
   - Motion Intensity: 5 (动态)
   - Quality Preset: 高清
6. 填写motion prompt: "Person running fast in the city"
7. 点击"生成视频"

**验证点**：
- [ ] WebSocket发送 `workspace.create` 包含v1.1字段
- [ ] 后端响应 `workspace.sync_confirm`
- [ ] 数据库保存正确的v1.1字段值
- [ ] POST `/api/generate/video` 包含v1.1字段
- [ ] 后端日志显示v1.1参数
- [ ] 视频生成任务开始（status = 'generating'）
- [ ] 轮询完成后视频URL返回
- [ ] 视频播放器显示生成的视频
- [ ] 生成的视频是9:16竖屏格式
- [ ] 生成的视频约8秒长

**记录**：
- 截图：表单填写 + 视频生成成功
- Network日志：WebSocket消息 + API请求
- 数据库截图：workspace document中的form_data

---

### 3. 测试用例2：加载旧Workspace并应用默认值

**目标**：验证向后兼容性

**准备**：
在MongoDB中手动插入一个v1.0格式的workspace（无v1.1字段）：

```javascript
mongosh

use video-maker
db.workspaces.insertOne({
  order_index: 99,
  image_path: '/uploads/test.jpg',
  image_url: '/uploads/test.jpg',
  form_data: {
    camera_movement: 'push',
    shot_type: 'medium',
    lighting: 'natural',
    motion_prompt: 'Old workspace test',
    checkboxes: {}
    // 注意：没有v1.1字段！
  },
  video: { status: 'pending', task_id: '', url: '', error: '' },
  ai_collaboration: [],
  created_at: new Date(),
  updated_at: new Date()
})
```

**步骤**：
1. 刷新浏览器（或重新加载页面）
2. 找到order_index=99的workspace
3. 点击打开该workspace
4. 查看表单字段

**验证点**：
- [ ] 页面正常加载，无错误
- [ ] Duration显示：4秒（默认值）
- [ ] Aspect Ratio显示：16:9（默认值）
- [ ] Motion Intensity显示：3 - 中等（默认值）
- [ ] Quality Preset显示：标准（默认值）
- [ ] v1.0字段（motion_prompt等）正常显示
- [ ] 可以修改v1.1字段并保存
- [ ] 修改后数据库包含v1.1字段

**记录**：
- 截图：旧workspace加载成功，显示默认值
- 数据库截图：修改前后对比

---

### 4. 测试用例3：增量更新v1.1字段

**目标**：验证WebSocket增量更新

**步骤**：
1. 打开一个workspace
2. 只修改Duration：从4秒改为6秒
3. 观察Network → WS消息
4. 不提交表单，直接修改Aspect Ratio：从16:9改为1:1
5. 再观察WS消息

**验证点**：
- [ ] 修改Duration后，WebSocket只发送 `{ duration: 6 }`（增量更新）
- [ ] 修改Aspect Ratio后，WebSocket只发送 `{ aspect_ratio: '1:1' }`
- [ ] 两次更新都收到 `workspace.sync_confirm`
- [ ] 数据库正确更新两个字段
- [ ] 其他字段（如motion_intensity）未被改变
- [ ] 防抖生效（300ms内连续修改只发送最后一次）

**记录**：
- WebSocket消息截图
- 数据库更新截图

---

### 5. 测试用例4：参数验证

**目标**：验证前后端都正确验证参数

**步骤**：

**Test 4.1: 前端验证（如果实现了）**
- 尝试手动修改代码，发送无效duration值（如10）
- 预期：前端拒绝或后端返回错误

**Test 4.2: 后端API验证**
使用curl或Postman发送无效参数：

```bash
# 无效duration
curl -X POST http://localhost:3000/api/generate/video \
  -H "Content-Type: application/json" \
  -d '{
    "workspace_id": "WORKSPACE_ID",
    "form_data": {
      "motion_prompt": "test",
      "duration": 10
    }
  }'

# 预期：400 Bad Request { "error": "Invalid duration: 10" }

# 无效aspect_ratio
curl -X POST http://localhost:3000/api/generate/video \
  -H "Content-Type: application/json" \
  -d '{
    "workspace_id": "WORKSPACE_ID",
    "form_data": {
      "motion_prompt": "test",
      "aspect_ratio": "21:9"
    }
  }'

# 预期：400 Bad Request { "error": "Invalid aspect_ratio: 21:9" }
```

**验证点**：
- [ ] 无效duration被拒绝（400错误）
- [ ] 无效aspect_ratio被拒绝
- [ ] 无效motion_intensity被拒绝（<1 或 >5）
- [ ] 无效quality_preset被拒绝
- [ ] 错误消息清晰描述问题
- [ ] 日志记录验证失败

---

### 6. 测试用例5：不同参数组合的视频生成

**目标**：验证各种参数组合都能正确生成视频

**测试矩阵**：

| Test | Duration | Aspect Ratio | Motion Intensity | Quality | 预期结果 |
|------|----------|--------------|------------------|---------|---------|
| 5.1  | 2s       | 16:9         | 1 (极慢)         | draft   | 2秒横屏视频，运动缓慢，720p |
| 5.2  | 4s       | 9:16         | 3 (中等)         | standard| 4秒竖屏视频，运动自然，1080p |
| 5.3  | 6s       | 1:1          | 5 (极快)         | high    | 6秒方形视频，运动快速，高清 |
| 5.4  | 8s       | 4:3          | 2 (慢速)         | draft   | 8秒4:3视频，运动慢，720p |

**对于每个test**：
1. 创建新workspace
2. 上传相同图片
3. 设置对应参数组合
4. 提交生成
5. 等待完成
6. 验证视频属性

**验证点**：
- [ ] 所有4个组合都能成功生成视频
- [ ] 视频时长符合设置（±0.5秒误差可接受）
- [ ] 视频宽高比符合设置
- [ ] 运动速度与intensity设置相符（主观判断）
- [ ] 质量预设影响生成时间（draft < standard < high）

**记录**：
- 4个测试的视频截图
- 生成时间记录
- 视频属性验证（使用ffprobe或视频播放器）

---

### 7. 测试用例6：并发操作

**目标**：验证多个workspace同时操作

**步骤**：
1. 创建3个workspace
2. 同时修改它们的v1.1字段
3. 观察WebSocket消息和数据库更新

**验证点**：
- [ ] WebSocket消息不混淆（每个workspace的id正确）
- [ ] 数据库正确更新每个workspace
- [ ] UI显示正确的workspace状态
- [ ] 无race condition或数据覆盖

---

### 8. 性能测试

**目标**：确保v1.1不影响性能

**测试**：
- 创建20个workspace
- 快速修改多个workspace的v1.1字段
- 测量UI响应时间和WebSocket延迟

**验证点**：
- [ ] 表单交互流畅（<100ms响应）
- [ ] WebSocket消息延迟 <500ms
- [ ] 页面加载时间无明显增加
- [ ] 内存占用正常

---

### 9. 浏览器兼容性测试

**目标**：确保主流浏览器都支持

**测试浏览器**：
- Chrome/Edge
- Firefox
- Safari (如有Mac)

**验证点**：
- [ ] 所有浏览器UI正常显示
- [ ] Range slider（motion_intensity）正常工作
- [ ] WebSocket连接正常
- [ ] 视频播放正常

---

## 测试报告模板

创建测试报告：`ai-output-resource/docs/v1.1-integration-test-report.md`

```markdown
# v1.1 Integration Test Report

## 测试环境
- Date: 2025-01-XX
- Frontend: http://localhost:5173
- Backend: http://localhost:3000
- Database: MongoDB 6.0
- Qwen API: 可用

## 测试结果摘要

| 测试用例 | 状态 | 备注 |
|---------|------|------|
| 1. 创建新workspace | ✅ Pass | |
| 2. 加载旧workspace | ✅ Pass | |
| 3. 增量更新 | ✅ Pass | |
| 4. 参数验证 | ✅ Pass | |
| 5. 视频生成矩阵 | ✅ Pass | |
| 6. 并发操作 | ✅ Pass | |
| 7. 性能测试 | ✅ Pass | |
| 8. 浏览器兼容 | ✅ Pass | |

## 详细测试结果

(每个测试用例的详细记录)

## 发现的问题

(列出所有bug和待修复项)

## 结论

[] v1.1功能完整可用，可以进入下一阶段
[] 有轻微问题，需要修复后再测试
[] 有严重问题，需要返工
```

## 验收标准

- [ ] 所有8个主要测试用例通过
- [ ] 测试报告已创建并完整填写
- [ ] 所有截图和日志已保存
- [ ] 发现的bug已记录并修复（或计划修复）
- [ ] 视频生成成功率 >90%
- [ ] 无数据丢失或损坏
- [ ] UI无明显bug或崩溃
- [ ] 向后兼容性100%通过

## 输出物

1. 测试报告：`ai-output-resource/docs/v1.1-integration-test-report.md`
2. 测试截图：`ai-output-resource/test-screenshots/v1.1/`
3. 测试视频：保存生成的测试视频样本
4. 性能数据：响应时间、生成时间等

## 常见问题排查

### 问题1：视频生成失败
- 检查Qwen API密钥
- 查看后端日志：`tail -f backend/logs/error.log`
- 检查API参数映射是否正确

### 问题2：WebSocket断开
- 检查防火墙设置
- 查看浏览器console错误
- 确认后端WebSocket服务运行

### 问题3：旧workspace加载失败
- 检查`applyV1_1Defaults`函数
- 验证数据库schema
- 查看前端console错误

## 下一步

- v1.1-6.2-backward-compatibility.md (向后兼容性专项测试)

## 预计耗时
4 小时

## 依赖任务
- v1.1-4.1-update-video-form.md
- v1.1-4.2-update-workspace-store.md
- v1.1-5.1-update-generate-video-api.md
- v1.1-5.2-update-websocket-handlers.md
