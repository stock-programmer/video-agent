# v1.1 任务 6.2 - 向后兼容性验证

## 层级
第6层 - 依赖 6.1

## 并行任务
无（必须在集成测试之后）

## 任务目标
专门验证v1.1与v1.0的向后兼容性，确保现有用户数据和工作流不受影响。

## 前置条件
- 任务 6.1 已完成（集成测试通过）
- 有v1.0版本的workspace数据（真实或模拟）

## 执行步骤

### 1. 准备v1.0测试数据

创建包含v1.0格式workspace的测试数据库：

**文件**: `backend/test-data/v1.0-workspaces.json`

```json
[
  {
    "order_index": 0,
    "image_path": "/uploads/test1.jpg",
    "image_url": "http://localhost:3000/uploads/test1.jpg",
    "form_data": {
      "camera_movement": "push",
      "shot_type": "medium",
      "lighting": "natural",
      "motion_prompt": "Person walking slowly in the park",
      "checkboxes": {
        "stabilization": true
      }
    },
    "video": {
      "status": "completed",
      "task_id": "task_123",
      "url": "http://example.com/video1.mp4",
      "error": ""
    },
    "ai_collaboration": [
      {
        "user_input": "Too slow",
        "ai_suggestion": "Increase motion speed",
        "timestamp": "2025-01-01T00:00:00Z"
      }
    ],
    "created_at": "2025-01-01T00:00:00Z",
    "updated_at": "2025-01-01T00:00:00Z"
  },
  {
    "order_index": 1,
    "image_path": "/uploads/test2.jpg",
    "image_url": "http://localhost:3000/uploads/test2.jpg",
    "form_data": {
      "camera_movement": "pan",
      "shot_type": "wide",
      "lighting": "soft",
      "motion_prompt": "City skyline at sunset",
      "checkboxes": {}
    },
    "video": {
      "status": "pending",
      "task_id": "",
      "url": "",
      "error": ""
    },
    "ai_collaboration": [],
    "created_at": "2025-01-02T00:00:00Z",
    "updated_at": "2025-01-02T00:00:00Z"
  }
]
```

### 2. 导入v1.0测试数据

```bash
# 备份当前数据库
mongodump --db=video-maker --out=./backup/before-v1.0-test

# 清空workspaces collection
mongosh video-maker --eval "db.workspaces.deleteMany({})"

# 导入v1.0测试数据
mongoimport --db=video-maker --collection=workspaces \
  --file=backend/test-data/v1.0-workspaces.json --jsonArray
```

### 3. 测试场景1：前端加载v1.0数据

**目标**：验证前端能够正确加载和显示v1.0 workspace

**步骤**：
1. 启动前后端服务
2. 打开浏览器：`http://localhost:5173`
3. 检查timeline，应该看到2个workspace
4. 点击打开第一个workspace（order_index: 0）
5. 检查表单字段

**验证点**：
- [ ] 页面正常加载，无JavaScript错误
- [ ] 显示2个workspace
- [ ] v1.0字段正常显示：
  - [ ] camera_movement: "push"
  - [ ] shot_type: "medium"
  - [ ] lighting: "natural"
  - [ ] motion_prompt: "Person walking slowly in the park"
- [ ] v1.1字段显示默认值：
  - [ ] duration: 4秒
  - [ ] aspect_ratio: 16:9
  - [ ] motion_intensity: 3
  - [ ] quality_preset: 标准
- [ ] 视频状态正确显示（completed）
- [ ] AI协作历史正确显示

**记录**：
- 截图：v1.0 workspace在v1.1界面中的显示
- Console日志（应该无错误）

---

### 4. 测试场景2：修改v1.0 workspace并保存

**目标**：验证修改旧workspace不会破坏数据

**步骤**：
1. 打开第一个workspace
2. 修改v1.0字段：motion_prompt改为 "Person jogging"
3. 修改v1.1字段：duration改为 6秒
4. 不提交视频生成，只是保存表单
5. 查看WebSocket消息
6. 查看数据库

**验证点**：
- [ ] WebSocket发送增量更新
- [ ] 数据库更新后，workspace包含：
  - [ ] 旧的v1.0字段（未修改的保持原值）
  - [ ] 修改后的v1.0字段（motion_prompt: "Person jogging"）
  - [ ] 新增的v1.1字段（duration: 6, aspect_ratio: '16:9', motion_intensity: 3, quality_preset: 'standard'）
- [ ] video、ai_collaboration、created_at等字段未被改变
- [ ] order_index保持为0

**MongoDB查询验证**：
```bash
mongosh video-maker --eval "
  db.workspaces.findOne({ order_index: 0 }, { form_data: 1, video: 1 })
"

# 预期输出：
# {
#   form_data: {
#     camera_movement: 'push',
#     shot_type: 'medium',
#     lighting: 'natural',
#     motion_prompt: 'Person jogging',  // 已修改
#     checkboxes: { stabilization: true },
#     duration: 6,                       // 新增
#     aspect_ratio: '16:9',              // 新增
#     motion_intensity: 3,               // 新增
#     quality_preset: 'standard'         // 新增
#   },
#   video: {
#     status: 'completed',               // 未改变
#     task_id: 'task_123',
#     url: 'http://example.com/video1.mp4',
#     error: ''
#   }
# }
```

---

### 5. 测试场景3：为v1.0 workspace生成新视频

**目标**：验证v1.0 workspace可以使用v1.1参数生成视频

**步骤**：
1. 打开第二个workspace（order_index: 1，video status: pending）
2. 修改v1.1参数：
   - duration: 8秒
   - aspect_ratio: 9:16
   - motion_intensity: 5
   - quality_preset: high
3. 提交视频生成
4. 等待生成完成

**验证点**：
- [ ] POST `/api/generate/video` 包含v1.1参数
- [ ] Qwen API接收正确的参数
- [ ] 视频生成成功
- [ ] 生成的视频是9:16竖屏格式
- [ ] 视频时长约8秒
- [ ] 数据库video字段更新为completed
- [ ] video.url已填充

---

### 6. 测试场景4：数据库迁移脚本

**目标**：验证迁移脚本正确处理v1.0数据

**步骤**：
1. 重新导入纯v1.0数据（无v1.1字段）
2. 运行迁移脚本：`node backend/migrate-v1-1.js`
3. 检查数据库

**验证点**：
- [ ] 迁移脚本成功执行，无错误
- [ ] 所有workspace都包含v1.1字段
- [ ] 默认值正确：
  - duration: 4
  - aspect_ratio: '16:9'
  - motion_intensity: 3
  - quality_preset: 'standard'
- [ ] v1.0字段完全保留，无数据丢失
- [ ] video、ai_collaboration等其他字段未受影响
- [ ] created_at、updated_at未被改变

**迁移前后对比**：
```bash
# 迁移前
db.workspaces.findOne({ order_index: 0 }).form_data
# { camera_movement: 'push', shot_type: 'medium', ... }  // 无v1.1字段

# 运行迁移
node backend/migrate-v1-1.js

# 迁移后
db.workspaces.findOne({ order_index: 0 }).form_data
# {
#   camera_movement: 'push',
#   shot_type: 'medium',
#   ...
#   duration: 4,                    // 新增
#   aspect_ratio: '16:9',           // 新增
#   motion_intensity: 3,            // 新增
#   quality_preset: 'standard'      // 新增
# }
```

---

### 7. 测试场景5：API向后兼容

**目标**：验证API接受缺少v1.1字段的请求

**步骤**：

使用curl模拟v1.0客户端发送请求（不包含v1.1字段）：

```bash
# 创建workspace (v1.0格式)
curl -X POST http://localhost:3000/api/workspaces \
  -H "Content-Type: application/json" \
  -d '{
    "form_data": {
      "camera_movement": "push",
      "shot_type": "medium",
      "lighting": "natural",
      "motion_prompt": "Test"
    },
    "image_path": "/uploads/test.jpg",
    "image_url": "/uploads/test.jpg"
  }'

# 生成视频 (v1.0格式，无v1.1参数)
curl -X POST http://localhost:3000/api/generate/video \
  -H "Content-Type: application/json" \
  -d '{
    "workspace_id": "WORKSPACE_ID",
    "form_data": {
      "camera_movement": "push",
      "motion_prompt": "Old format request"
    }
  }'
```

**验证点**：
- [ ] 请求成功（200 OK），无400错误
- [ ] 后端自动应用v1.1默认值
- [ ] 视频生成成功
- [ ] 数据库包含完整的v1.1字段

---

### 8. 测试场景6：WebSocket向后兼容

**目标**：验证WebSocket接受v1.0格式消息

**测试脚本**: `backend/test-ws-backward-compat.js`

```javascript
const WebSocket = require('ws');

const ws = new WebSocket('ws://localhost:3001');

ws.on('open', () => {
  console.log('Testing WebSocket backward compatibility\n');

  // v1.0格式：创建workspace（无v1.1字段）
  ws.send(JSON.stringify({
    type: 'workspace.create',
    data: {
      form_data: {
        camera_movement: 'push',
        shot_type: 'medium',
        lighting: 'natural',
        motion_prompt: 'v1.0 format test',
        checkboxes: {}
      },
      image_path: '/test.jpg',
      image_url: '/test.jpg'
    }
  }));

  setTimeout(() => {
    // v1.0格式：更新workspace（只更新v1.0字段）
    ws.send(JSON.stringify({
      type: 'workspace.update',
      data: {
        id: 'WORKSPACE_ID',
        form_data: {
          motion_prompt: 'Updated with v1.0 format'
        }
      }
    }));
  }, 2000);

  setTimeout(() => {
    ws.close();
    process.exit(0);
  }, 4000);
});

ws.on('message', (data) => {
  const msg = JSON.parse(data.toString());
  console.log('Received:', msg.type);
  if (msg.type === 'workspace.sync_confirm') {
    console.log('form_data:', msg.data.form_data);
    console.log('✅ Has v1.1 defaults:',
      'duration' in msg.data.form_data &&
      'aspect_ratio' in msg.data.form_data
    );
  }
});
```

**验证点**：
- [ ] WebSocket接受v1.0格式消息
- [ ] 返回的workspace包含v1.1默认值
- [ ] 无错误或警告

---

### 9. 编写兼容性测试报告

**文件**: `ai-output-resource/docs/v1.1-backward-compatibility-report.md`

```markdown
# v1.1 Backward Compatibility Report

## 测试日期
2025-01-XX

## 测试概述
验证v1.1版本与v1.0数据和客户端的向后兼容性。

## 测试环境
- v1.0 test data: 2 workspaces
- Frontend: v1.1
- Backend: v1.1
- Database: MongoDB 6.0

## 测试结果

| 场景 | 状态 | 备注 |
|------|------|------|
| 1. 前端加载v1.0数据 | ✅ Pass | 自动应用默认值 |
| 2. 修改v1.0 workspace | ✅ Pass | 数据完整保留 |
| 3. 为v1.0生成新视频 | ✅ Pass | v1.1参数生效 |
| 4. 数据库迁移脚本 | ✅ Pass | 无数据丢失 |
| 5. API向后兼容 | ✅ Pass | 接受v1.0请求 |
| 6. WebSocket向后兼容 | ✅ Pass | 接受v1.0消息 |

## 数据完整性检查

- ✅ 所有v1.0字段完全保留
- ✅ video状态和URL未被改变
- ✅ ai_collaboration历史完整
- ✅ created_at/updated_at正确
- ✅ order_index保持不变

## 默认值应用

- ✅ duration: 4秒
- ✅ aspect_ratio: '16:9'
- ✅ motion_intensity: 3
- ✅ quality_preset: 'standard'

## 结论

✅ v1.1完全向后兼容v1.0

用户可以无缝升级，无需任何数据迁移或手动操作。
```

## 验收标准

- [ ] 所有6个测试场景通过
- [ ] v1.0 workspace在v1.1中正常工作
- [ ] 修改v1.0 workspace不破坏数据
- [ ] 可以为v1.0 workspace生成视频
- [ ] 数据库迁移脚本正确执行
- [ ] API和WebSocket接受v1.0格式请求
- [ ] 无数据丢失或损坏
- [ ] 向后兼容性报告已完成

## 输出物

1. 测试报告：`ai-output-resource/docs/v1.1-backward-compatibility-report.md`
2. 测试数据：`backend/test-data/v1.0-workspaces.json`
3. 测试脚本：`backend/test-ws-backward-compat.js`
4. 数据库备份：`backup/before-v1.0-test/`
5. 测试截图

## 回滚方案

如果发现兼容性问题：

```bash
# 恢复数据库备份
mongorestore --db=video-maker ./backup/before-v1.0-test/video-maker/

# 回滚代码
git revert <commit-hash>

# 重新部署v1.0
```

## 下一步

- v1.1-7.1-update-documentation.md (更新文档)

## 预计耗时
2 小时

## 依赖任务
- v1.1-6.1-integration-testing.md
