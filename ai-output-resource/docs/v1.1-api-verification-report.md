# v1.1 Qwen API参数验证报告

## 测试日期
2025-01-13

## 测试方法
基于Qwen官方API文档分析（`context/third-part/qwen-pic-to-video-first-pic.txt`）

## 测试模型
**wan2.6-i2v** (推荐使用的最新版本)
- 分辨率档位：720P、1080P
- 视频时长：5秒、10秒、15秒
- 固定规格：30fps、MP4 (H.264编码)

---

## 参数验证结果

### 1. Duration (视频时长)

**测试参数名**: `duration`
**我们需要的值**: 2, 4, 6, 8 (秒)
**API支持**: ⚠️ **部分支持**

**实际参数名**: `parameters.duration`
**API支持的值**: 5, 10, 15 (秒)
**默认值**: 5秒

**文档说明**:
```
wan2.6-i2v：可选值为5、10、15。默认值为5。
```

**问题**:
- ❌ API不支持2秒
- ❌ API不支持4秒
- ❌ API不支持6秒
- ❌ API不支持8秒

**建议方案**:

#### 方案A: 调整v1.1需求（推荐）
将duration选项改为匹配API：
- 5秒（短视频）
- 10秒（标准）
- 15秒（长视频）

#### 方案B: 使用近似值
- 2秒 → 使用5秒（最小值）
- 4秒 → 使用5秒
- 6秒 → 使用5秒或10秒
- 8秒 → 使用10秒

#### 方案C: 后期裁剪（不推荐）
- 生成10秒视频，后期裁剪到8秒
- 缺点：浪费API费用，增加处理复杂度

**最终建议**: **采用方案A**，修改`business-v1-1.md`中的duration选项为5/10/15秒。

---

### 2. Aspect Ratio (宽高比)

**测试参数名**: `aspect_ratio`
**我们需要的值**: "16:9", "9:16", "1:1", "4:3"
**API支持**: ❌ **不直接支持**

**实际参数名**: 无
**API行为**: 输出视频的宽高比**由输入图像的宽高比决定**

**文档说明**:
```
输出视频的宽高比由输入首帧图像（img_url）决定，但无法保证精确比例。
模型以输入图像的宽高比为基准，然后根据 resolution 参数适配到合法分辨率。
```

**示例**:
```
输入图像：750×1000 (宽高比 3:4 = 0.75)
设置 resolution = "720P"
实际输出：816×1104 (宽高比 ≈ 0.739)
```

**Workaround方案**:

#### 方案A: 前端裁剪图片（推荐）
用户选择宽高比后，前端使用canvas裁剪/调整图片：
```javascript
// 16:9 → 1920×1080
// 9:16 → 1080×1920
// 1:1 → 1080×1080
// 4:3 → 1440×1080
```

#### 方案B: 后端裁剪图片
上传后，后端使用图像处理库（如Sharp）裁剪：
```javascript
const sharp = require('sharp');
await sharp(inputPath)
  .resize({
    width: targetWidth,
    height: targetHeight,
    fit: 'cover' // 裁剪填充
  })
  .toFile(outputPath);
```

#### 方案C: 后处理视频（不推荐）
生成后裁剪视频，复杂且耗时。

**最终建议**: **采用方案A（前端裁剪）**，实现简单且用户可预览裁剪效果。

---

### 3. Motion Intensity (运动强度)

**测试参数名**: `motion_intensity`, `strength`
**我们需要的值**: 1-5 scale
**API支持**: ❌ **不支持**

**实际参数名**: 无
**API行为**: 无相关参数

**文档中未找到任何与"运动强度"/"motion intensity"/"strength"相关的参数。**

**Workaround方案**:

在`prompt`中添加强度关键词：

| Intensity | 关键词 | 示例Prompt |
|-----------|--------|-----------|
| 1 (极慢) | "very slowly", "subtle movement", "barely moving" | "Person walking very slowly, subtle movement" |
| 2 (慢速) | "slowly", "gently", "calm" | "Person walking slowly and gently" |
| 3 (中等) | "naturally", "moderate", 无特殊关键词 | "Person walking naturally" |
| 4 (快速) | "quickly", "fast", "dynamic" | "Person running quickly with dynamic motion" |
| 5 (极快) | "very fast", "rapidly", "energetically", "high speed" | "Person sprinting very fast, high energy movements" |

**实现方式**:
```javascript
function enhancePromptWithIntensity(prompt, intensity) {
  const keywords = {
    1: 'very slowly, with subtle movement',
    2: 'slowly and gently',
    3: 'naturally',  // 默认，不添加
    4: 'quickly and dynamically',
    5: 'very fast, with high energy and rapid movements'
  };

  if (intensity === 3) return prompt; // 默认，不修改

  return `${prompt}, ${keywords[intensity]}`;
}
```

**最终建议**: 在后端`services/video-qwen.js`中实现prompt增强逻辑。

---

### 4. Quality / Resolution (质量)

**测试参数名**: `quality`, `resolution`
**我们需要的值**: "draft", "standard", "high"
**API支持**: ✅ **完全支持**

**实际参数名**: `parameters.resolution`
**API支持的值**: "720P", "1080P" (wan2.6-i2v)
**默认值**: "1080P"

**文档说明**:
```
wan2.6-i2v：可选值：720P、1080P。默认值为1080P。
```

**参数映射**:

| v1.1 UI | Qwen API | 分辨率 | 预计时间 | 备注 |
|---------|----------|--------|---------|------|
| draft   | 720P     | 1280×720 | ~1-2分钟 | 快速预览 |
| standard | 1080P   | 1920×1080 | ~2-4分钟 | 推荐 ✓ |
| high    | 1080P    | 1920×1080 | ~2-4分钟 | 与standard相同 |

**注意**:
- wan2.6模型只有720P和1080P两档，没有更高的分辨率
- "high"质量与"standard"将使用相同的1080P参数
- 可以考虑只保留两档：Draft (720P) 和 Standard (1080P)

**实现代码**:
```javascript
function mapQualityToResolution(quality_preset) {
  const mapping = {
    'draft': '720P',
    'standard': '1080P',
    'high': '1080P'  // 与standard相同
  };
  return mapping[quality_preset] || '1080P';
}
```

**最终建议**: ✅ 直接映射，无需修改需求。

---

## 其他发现的有用参数

### 1. seed (随机种子)
```
seed integer (可选)
取值范围: [0, 2147483647]
用途: 提升生成结果的可复现性
```
**建议**: 可在v1.2中添加，用于"重新生成相同视频"功能。

### 2. negative_prompt (反向提示词)
```
negative_prompt string (可选)
用途: 描述不希望在视频中看到的内容
长度: 不超过500字符
示例: "低分辨率、错误、最差质量、残缺、多余的手指"
```
**建议**: 可在v1.2中添加"高级设置"。

### 3. prompt_extend (智能改写)
```
prompt_extend boolean (可选)
默认: true
用途: 使用大模型改写prompt，提升生成效果
```
**当前状态**: 默认开启，无需用户配置。

### 4. watermark (水印)
```
watermark boolean (可选)
默认: false
用途: 添加"AI生成"水印
```
**建议**: 保持默认关闭。

---

## 完整参数映射表

| v1.1 UI参数 | Qwen API参数 | 值映射 | 支持状态 | Workaround |
|------------|--------------|--------|---------|-----------|
| duration: 2 | parameters.duration | ❌ 不支持 | ⚠️ 部分 | 改为5秒 |
| duration: 4 | parameters.duration | ❌ 不支持 | ⚠️ 部分 | 改为5秒 |
| duration: 6 | parameters.duration | ❌ 不支持 | ⚠️ 部分 | 改为5或10秒 |
| duration: 8 | parameters.duration | ❌ 不支持 | ⚠️ 部分 | 改为10秒 |
| **调整后** | | | | |
| duration: 5 | parameters.duration | 5 | ✅ 支持 | 无需workaround |
| duration: 10 | parameters.duration | 10 | ✅ 支持 | 无需workaround |
| duration: 15 | parameters.duration | 15 | ✅ 支持 | 无需workaround |
| aspect_ratio: '16:9' | 输入图像宽高比 | 1920×1080 | ❌ 间接 | 前端裁剪图片 |
| aspect_ratio: '9:16' | 输入图像宽高比 | 1080×1920 | ❌ 间接 | 前端裁剪图片 |
| aspect_ratio: '1:1' | 输入图像宽高比 | 1080×1080 | ❌ 间接 | 前端裁剪图片 |
| aspect_ratio: '4:3' | 输入图像宽高比 | 1440×1080 | ❌ 间接 | 前端裁剪图片 |
| motion_intensity: 1 | input.prompt (增强) | "very slowly..." | ❌ 间接 | Prompt增强 |
| motion_intensity: 2 | input.prompt (增强) | "slowly..." | ❌ 间接 | Prompt增强 |
| motion_intensity: 3 | input.prompt | 无修改 | ✅ 默认 | 无需处理 |
| motion_intensity: 4 | input.prompt (增强) | "quickly..." | ❌ 间接 | Prompt增强 |
| motion_intensity: 5 | input.prompt (增强) | "very fast..." | ❌ 间接 | Prompt增强 |
| quality_preset: 'draft' | parameters.resolution | "720P" | ✅ 支持 | 无需workaround |
| quality_preset: 'standard' | parameters.resolution | "1080P" | ✅ 支持 | 无需workaround |
| quality_preset: 'high' | parameters.resolution | "1080P" | ✅ 支持 | 与standard相同 |

---

## 建议的v1.1参数调整

### 原计划（business-v1-1.md）
```typescript
duration: 2 | 4 | 6 | 8  // ❌ API不支持
aspect_ratio: '16:9' | '9:16' | '1:1' | '4:3'  // ⚠️ 需前端裁剪
motion_intensity: 1 | 2 | 3 | 4 | 5  // ⚠️ 需prompt增强
quality_preset: 'draft' | 'standard' | 'high'  // ✅ 完全支持
```

### 建议调整后
```typescript
duration: 5 | 10 | 15  // ✅ 匹配API
aspect_ratio: '16:9' | '9:16' | '1:1' | '4:3'  // 保持不变，前端裁剪
motion_intensity: 1 | 2 | 3 | 4 | 5  // 保持不变，prompt增强
quality_preset: 'draft' | 'standard'  // 简化为两档（high=standard）
```

---

## API调用示例代码

```javascript
// 基于文档的API调用示例
const axios = require('axios');

async function generateVideo(workspace_id, formData) {
  const {
    motion_prompt,
    duration = 5,
    aspect_ratio = '16:9',
    motion_intensity = 3,
    quality_preset = 'standard'
  } = formData;

  // 1. 映射质量参数
  const resolution = quality_preset === 'draft' ? '720P' : '1080P';

  // 2. 增强prompt（如果intensity不是默认值）
  let enhancedPrompt = motion_prompt;
  if (motion_intensity !== 3) {
    const intensityKeywords = {
      1: 'very slowly, with subtle and minimal movement',
      2: 'slowly and gently',
      4: 'quickly with dynamic motion',
      5: 'very fast, with high energy and rapid movements'
    };
    enhancedPrompt = `${motion_prompt}, ${intensityKeywords[motion_intensity]}`;
  }

  // 3. 调用API创建任务
  const response = await axios.post(
    'https://dashscope.aliyuncs.com/api/v1/services/aigc/video-generation/video-synthesis',
    {
      model: 'wan2.6-i2v',
      input: {
        prompt: enhancedPrompt,
        img_url: imageUrl  // 前端已按aspect_ratio裁剪
      },
      parameters: {
        resolution: resolution,
        duration: duration,  // 5, 10, or 15
        prompt_extend: true
      }
    },
    {
      headers: {
        'Authorization': `Bearer ${process.env.DASHSCOPE_API_KEY}`,
        'Content-Type': 'application/json',
        'X-DashScope-Async': 'enable'
      }
    }
  );

  return response.data.output.task_id;
}
```

---

## 结论

### 总体评估
- ✅ **1个参数完全支持**: quality_preset (通过resolution参数)
- ⚠️ **1个参数部分支持**: duration (需调整选项为5/10/15秒)
- ⚠️ **2个参数需workaround**: aspect_ratio (前端裁剪), motion_intensity (prompt增强)

### 推荐实施方案

**优先级1（必须）**:
1. ✅ 修改`business-v1-1.md`，将duration改为5/10/15秒
2. ✅ 实现前端图片裁剪功能（aspect_ratio）
3. ✅ 实现后端prompt增强逻辑（motion_intensity）
4. ✅ 实现quality到resolution的直接映射

**优先级2（可选）**:
- 考虑将quality简化为两档（Draft/Standard），因为high与standard无差异
- 为future-proof，保留三档UI，但high和standard使用相同API参数

### 风险与限制

**风险**:
1. 用户可能期望2/4/6/8秒的时长，调整为5/10/15秒可能不符合预期
2. 图片裁剪可能改变构图，影响视频质量
3. Prompt增强的效果依赖文本，可能不如原生参数精确

**建议缓解措施**:
1. 在UI中明确标注"视频时长：5秒/10秒/15秒"
2. 提供裁剪预览，让用户调整裁剪区域（v1.2功能）
3. 在文档中说明motion_intensity通过智能prompt增强实现

---

## 下一步行动

1. ✅ 更新`business-v1-1.md`中的duration选项
2. ✅ 创建前端图片裁剪工具函数（或使用第三方库）
3. ✅ 创建后端prompt增强函数
4. ✅ 更新所有v1.1任务文档以反映参数调整
5. ✅ 继续执行Task 2.1（数据库Schema更新）

---

## 附录：API文档位置

- 完整文档：`context/third-part/qwen-pic-to-video-first-pic.txt`
- 模型：wan2.6-i2v
- API Base URL: `https://dashscope.aliyuncs.com/api/v1`
- 需要环境变量：`DASHSCOPE_API_KEY`
