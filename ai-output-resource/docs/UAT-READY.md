# UAT 测试准备完成

## 清理总结

### ✅ 已清理的内容

#### 1. 文件系统 (uploads目录)
- **图片文件**: 删除了 2 个测试图片
  - `1767008037365-8206bx2s.png` (1.9MB)
  - `1767012326405-wzqbc2i8.webp` (31KB)
- **视频文件**: 删除了 1 个测试视频
  - `695251e891fab49e9adb49a5_1767177366572.mp4` (4.4MB)
- **保留文件**: `.gitkeep` (保持目录结构)

#### 2. MongoDB数据库
- **删除记录**: 10 条工作空间记录
- **当前状态**: 0 条记录,数据库大小 0.00 KB

#### 3. 磁盘空间
- **清理前**: ~6.4MB
- **清理后**: 8.0KB (仅目录结构)

### 📊 验证结果

```
========================================
【文件系统检查】
  ✓ uploads/          - 仅包含 .gitkeep
  ✓ uploads/videos/   - 空目录

【数据库检查】
  ✓ workspaces集合    - 0 条记录
  ✓ 数据库大小        - 0.00 KB
  ✓ 集合数            - 1 (保留schema)

【磁盘空间】
  ✓ uploads/          - 8.0K
========================================
```

## 系统当前状态

### ✅ 干净的初始状态

1. **无测试数据** - 所有测试图片、视频、数据库记录已删除
2. **目录结构完整** - uploads/ 和 uploads/videos/ 目录保留
3. **数据库就绪** - MongoDB连接正常,Schema已初始化
4. **后端服务就绪** - 所有API和WebSocket服务正常运行
5. **前端服务就绪** - React应用已配置完成

### 📂 目录结构

```
backend/
├── uploads/
│   ├── .gitkeep              ✅ 保留
│   └── videos/               ✅ 空目录,等待视频下载
```

## UAT 测试准备工具

### 清理脚本

创建了可重复使用的清理脚本: `backend/clean-test-data.sh`

**使用方法**:
```bash
cd backend
bash clean-test-data.sh
```

**功能**:
- 交互式确认(防止误操作)
- 清理所有上传文件
- 清理所有视频文件
- 清理所有数据库记录
- 自动验证清理结果

## 可以开始 UAT 测试了!

### 测试场景建议

#### 场景 1: 完整工作流
1. **上传图片** - 测试拖放和文件选择
2. **填写表单** - 测试所有字段(运镜、景别、光线、提示词)
3. **生成视频** - 验证Qwen API调用和轮询
4. **自动下载** - 验证视频保存到本地 (新功能!)
5. **播放视频** - 验证本地视频URL正确
6. **刷新浏览器** - 验证数据持久化

#### 场景 2: 多工作空间
1. 创建多个工作空间
2. 测试拖拽排序
3. 测试删除工作空间
4. 验证WebSocket实时同步

#### 场景 3: AI协作
1. 输入视频描述
2. 获取AI建议
3. 应用建议到表单
4. 验证Gemini API集成

#### 场景 4: 错误处理
1. 上传过大文件
2. 未上传图片直接生成视频
3. 网络中断时的行为
4. API调用失败的处理

#### 场景 5: 视频本地存储验证 (重点!)
1. 生成视频后,检查 `backend/uploads/videos/` 目录
2. 验证文件命名格式: `{workspace_id}_{timestamp}.mp4`
3. 检查数据库字段:
   - `video.url`: `/uploads/videos/xxx.mp4`
   - `video.remote_url`: 原始Qwen URL
   - `video.path`: 本地文件系统路径
4. 关闭浏览器,重新打开,验证视频仍可播放
5. 断开网络,验证本地视频仍可访问

### 启动服务

#### 后端
```bash
cd backend
npm run dev
# 或
npm start
```

#### 前端
```bash
cd frontend
npm run dev
```

### 监控日志

```bash
# 实时查看后端日志
tail -f backend/logs/combined.log

# 查看错误日志
tail -f backend/logs/error.log
```

### 验证数据库

```bash
# 实时查看数据库变化
mongosh video-maker
> db.workspaces.find().pretty()

# 监控视频下载
watch -n 2 'ls -lh backend/uploads/videos/'
```

## 预期结果

### ✅ 成功标准

1. **图片上传** - 文件保存到 `uploads/`,URL正确返回
2. **表单验证** - 所有字段验证生效
3. **视频生成** - Qwen API调用成功,状态更新正确
4. **视频下载** - ⭐ 视频自动下载到 `uploads/videos/`
5. **视频播放** - ⭐ 使用本地URL播放,速度快
6. **数据持久化** - ⭐ 刷新后工作空间和视频都保留
7. **WebSocket同步** - 多窗口状态实时同步
8. **AI建议** - Gemini API返回合理建议
9. **错误提示** - 所有错误都有友好提示

### 📋 验证检查清单

- [ ] 图片上传成功
- [ ] 视频生成成功
- [ ] **视频下载到本地成功** (新功能)
- [ ] 视频播放流畅
- [ ] **刷新浏览器后视频仍可访问** (核心验证)
- [ ] 数据库记录正确
- [ ] WebSocket推送正常
- [ ] 工作空间排序正常
- [ ] AI建议功能正常
- [ ] 错误处理友好

## 测试数据收集

建议在测试过程中记录:

1. **性能数据**
   - 图片上传时间
   - 视频生成时长
   - 视频下载时长
   - 页面加载时间

2. **功能数据**
   - 成功/失败次数
   - 错误类型和频率
   - 用户操作流程

3. **文件数据**
   - 生成的视频文件大小
   - 磁盘空间使用情况
   - 数据库大小变化

## 已知限制 (MVP范围)

- ❌ 无用户认证
- ❌ 无权限控制
- ❌ 无任务队列
- ❌ 无缓存层
- ❌ 无监控告警

## 后续优化方向

1. **性能优化**
   - 视频轮询优化
   - WebSocket重连机制
   - 大文件上传优化

2. **功能增强**
   - 视频缩略图
   - 批量生成
   - 历史记录

3. **运维优化**
   - 云存储迁移(OSS/S3)
   - CDN加速
   - 自动清理过期文件

---

**祝 UAT 测试顺利! 🚀**

有任何问题请查看日志或运行:
```bash
cd backend
npm test  # 运行集成测试
```
